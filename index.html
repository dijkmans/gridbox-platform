<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gridbox Portal</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;
      --accent:#6d28d9;
      --accent2:#7c3aed;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow:0 8px 30px rgba(2,6,23,.08);
      --radius:18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--text);
    }

    a{color:inherit}
    .muted{color:var(--muted)}
    .hint{font-size:12px;color:var(--muted);margin-left:6px}
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#f9fafb;
      font-size:12px;
      color:#111827;
      user-select:none;
      white-space:nowrap;
    }
    .chip b{font-weight:600}

    .app{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:18px;
      padding:18px;
      height:100%;
      max-width:1400px;
      margin:0 auto;
    }

    .panel{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height:0;
    }

    .panel-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding:16px 16px 12px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg,#fff, #fbfbff);
    }
    .panel-header h2{
      margin:0;
      font-size:18px;
      line-height:1.2;
    }
    .panel-header .sub{
      margin-top:4px;
      font-size:13px;
      color:var(--muted);
    }
    .header-actions{
      display:flex;
      gap:8px;
      align-items:center;
    }

    .btn{
      border:0;
      background:linear-gradient(180deg,var(--accent2),var(--accent));
      color:#fff;
      padding:10px 14px;
      border-radius:14px;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 10px 18px rgba(109,40,217,.22);
    }
    .btn:active{transform:translateY(1px)}
    .btn-ghost{
      border:1px solid var(--border);
      background:#fff;
      color:#111827;
      padding:10px 14px;
      border-radius:14px;
      font-weight:600;
      cursor:pointer;
    }
    .btn-small{
      border:1px solid var(--border);
      background:#fff;
      color:#111827;
      padding:8px 12px;
      border-radius:12px;
      font-weight:600;
      cursor:pointer;
      font-size:13px;
    }

    .search-wrap{
      padding:12px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      gap:10px;
      align-items:center;
      background:#fff;
    }
    .search-wrap input{
      flex:1;
      border:1px solid var(--border);
      padding:10px 12px;
      border-radius:14px;
      outline:none;
      font-size:14px;
    }

    .cards{
      padding:12px;
      display:grid;
      gap:10px;
      overflow:auto;
      height:calc(100% - 112px);
    }

    .gb-card{
      position:relative;
      display:grid;
      grid-template-columns: 58px 1fr;
      gap:12px;
      align-items:center;
      padding:12px 12px 12px 10px;
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      cursor:pointer;
      user-select:none;
      transition:box-shadow .15s ease, transform .15s ease, border-color .15s ease;
      border-left:6px solid transparent;
    }
    .gb-card:hover{box-shadow:0 10px 24px rgba(2,6,23,.08)}
    .gb-card.is-selected{
      border-color:rgba(109,40,217,.35);
      box-shadow:0 14px 30px rgba(109,40,217,.12);
    }

    .gb-icon{
      width:58px;height:58px;
      border-radius:18px;
      display:grid;
      place-items:center;
      border:1px solid var(--border);
      background:linear-gradient(180deg,#fafaff,#fff);
      position:relative;
      overflow:hidden;
    }

    .gb-shutter{
      width:30px;height:30px;
      border-radius:10px;
      border:2px solid rgba(109,40,217,.35);
      position:relative;
    }
    .gb-shutter__door{
      position:absolute;
      left:0; right:0; top:0;
      height:100%;
      background:linear-gradient(180deg, rgba(109,40,217,.14), rgba(109,40,217,.04));
      transform:translateY(0%);
      transition:transform .35s ease;
      border-bottom:1px solid rgba(109,40,217,.25);
    }
    .gb-card.is-open .gb-shutter__door{ transform:translateY(-100%); }

    .gb-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .gb-title h3{
      margin:0;
      font-size:14px;
      line-height:1.2;
      font-weight:700;
    }
    .gb-meta{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--border);
      background:#fff;
      color:#111827;
      white-space:nowrap;
    }
    .pill .dot{width:8px;height:8px;border-radius:999px;background:var(--muted)}
    .pill.ok .dot{background:var(--ok)}
    .pill.bad .dot{background:var(--bad)}
    .pill.warn .dot{background:var(--warn)}
    .pill.ghost{background:#f8fafc}

    .card-actions{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    .side{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height:0;
      display:flex;
      flex-direction:column;
    }
    .side-header{
      padding:16px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg,#fff,#fbfbff);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .side-header h2{
      margin:0;
      font-size:18px;
      line-height:1.2;
    }
    .side-header .sub{
      margin-top:4px;
      font-size:13px;
      color:var(--muted);
    }
    .side-actions{
      display:flex;
      gap:8px;
      align-items:center;
    }

    .side-body{
      padding:12px 16px 18px;
      overflow:auto;
      min-height:0;
      display:grid;
      gap:12px;
    }

    .block{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    .block h4{
      margin:0 0 10px;
      font-size:14px;
      letter-spacing:.2px;
    }

    .kv{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap:8px 12px;
      align-items:center;
      font-size:14px;
    }
    .kv .muted{font-size:13px}

    .status-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding:7px 12px;
      font-weight:600;
      font-size:13px;
    }
    .status-pill .dot{width:9px;height:9px;border-radius:999px;background:var(--muted)}
    .status-pill.ok .dot{background:var(--ok)}
    .status-pill.bad .dot{background:var(--bad)}
    .status-pill.warn .dot{background:var(--warn)}

    .table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .table th,.table td{
      padding:10px 8px;
      border-bottom:1px solid var(--border);
      vertical-align:top;
    }
    .table th{
      text-align:left;
      color:var(--muted);
      font-weight:700;
      font-size:12px;
    }
    .table tr:last-child td{border-bottom:0}

    .form-row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-bottom:10px;
    }
    .field label{
      font-size:12px;
      color:var(--muted);
      display:block;
      margin-bottom:6px;
    }
    .field input{
      width:100%;
      border:1px solid var(--border);
      padding:10px 12px;
      border-radius:14px;
      outline:none;
      font-size:14px;
      background:#fff;
    }

    .phone-list{
      margin:0;
      padding-left:18px;
      color:#111827;
      font-size:13px;
    }

    .backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.35);
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease;
      z-index:40;
    }
    .backdrop.is-open{opacity:1;pointer-events:auto}

    .access-row{
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:16px;
      background:#fbfbff;
    }
    .access-left{min-width:0}
    .access-title{
      font-weight:800;
      margin-bottom:2px;
    }
    .access-sub{
      font-size:12px;
      color:var(--muted);
    }
    .access-right{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .badge.big{
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      background:#fff;
      border:1px solid var(--border);
      color:#111827;
    }

    .access-actions{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .access-actions .chip{margin-left:auto}

    details.details{
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      overflow:hidden;
    }
    details.details > summary{
      list-style:none;
      cursor:pointer;
      user-select:none;
      padding:12px 12px;
      font-weight:800;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:linear-gradient(180deg,#fff,#fbfbff);
      border-bottom:1px solid var(--border);
    }
    details.details > summary::-webkit-details-marker{display:none}
    .summary-right{
      display:inline-flex;
      align-items:center;
      gap:8px;
      color:var(--muted);
      font-weight:700;
      font-size:12px;
    }
    .details-body{
      padding:12px;
      display:grid;
      gap:12px;
    }

    .overview-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .overview-item{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 10px;
      background:#fff;
      min-height:54px;
    }
    .overview-item .label{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      letter-spacing:.2px;
    }
    .overview-item .value{
      margin-top:6px;
      font-size:14px;
      font-weight:800;
      color:#111827;
      word-break:break-word;
    }

    @media (max-width: 980px){
      .app{
        grid-template-columns:1fr;
        padding:12px;
      }
      .side{
        position:fixed;
        inset:10px;
        z-index:50;
        transform:translateY(14px);
        opacity:0;
        pointer-events:none;
        transition:opacity .2s ease, transform .2s ease;
      }
      .side.is-open{
        opacity:1;
        transform:translateY(0px);
        pointer-events:auto;
      }
      #btnCloseSide{display:inline-flex;}
      .cards{height:auto;max-height:60vh}
    }

    .app.is-expanded{grid-template-columns: 360px 1fr}
    .app.is-collapsed{grid-template-columns: 1fr}
    .side.is-wide .side-body{padding:12px 18px 18px}
  </style>
</head>

<body>
  <div class="app" id="app">
    <section class="panel" aria-label="Gridbox overzicht">
      <div class="panel-header">
        <div>
          <h2>Gridbox overzicht</h2>
          <div class="sub">Klik een box om te beheren.</div>
        </div>
        <div class="header-actions">
          <button class="btn-ghost" id="btnCollapse" type="button">Smaller</button>
          <button class="btn-ghost" id="btnExpand" type="button">Breder</button>
        </div>
      </div>

      <div class="search-wrap">
        <input id="q" placeholder="Zoek op site, klant, boxId..." />
      </div>

      <div class="cards" id="cards"></div>
    </section>

    <aside class="side" id="side" aria-label="Beheer en overzicht">
      <div class="side-header">
        <div>
          <h2 id="sideTitle">Selecteer een box</h2>
          <div class="sub" id="sideSub">Beheer en overzicht</div>
        </div>
        <div class="side-actions">
          <button class="btn-ghost" id="btnCloseSide" type="button">Sluiten</button>
          <button class="btn-ghost" id="btnToggleWide" type="button">Breed</button>
        </div>
      </div>

      <div class="side-body" id="sideBody">

        <div class="block" id="blockOverview">
          <h4>Overzicht</h4>

          <div class="overview-grid">
            <div class="overview-item">
              <div class="label">Online</div>
              <div class="value" id="ovOnline">-</div>
            </div>
            <div class="overview-item">
              <div class="label">Last seen</div>
              <div class="value" id="ovLastSeen">-</div>
            </div>
            <div class="overview-item">
              <div class="label">Open of closed</div>
              <div class="value" id="ovState">-</div>
            </div>
            <div class="overview-item">
              <div class="label">Shares</div>
              <div class="value" id="ovShares">-</div>
            </div>
            <div class="overview-item" style="grid-column: 1 / -1;">
              <div class="label">Adres</div>
              <div class="value" id="ovAddress">-</div>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <button class="btn" id="btnOpenTop" type="button">OPEN</button>
            <button class="btn-ghost" id="btnCloseTop" type="button">CLOSE</button>
            <button class="btn-small" id="btnGoShares" type="button">Shares beheren</button>
            <span class="chip">Beheeractie wordt gelogd als portaal</span>
          </div>
        </div>

        <div class="block" id="blockShares">
          <h4>Shares</h4>

          <div class="form-row">
            <div class="field">
              <label for="sharePhone">Telefoon</label>
              <input id="sharePhone" placeholder="+32..." inputmode="tel" />
            </div>
            <div class="field">
              <label for="shareExpires">Vervalt op</label>
              <input id="shareExpires" placeholder="bv 19/12/2025 22:00" />
            </div>
          </div>

          <div class="field" style="margin-bottom:10px">
            <label for="shareComment">Commentaar</label>
            <input id="shareComment" placeholder="bv Afhaling..." />
          </div>

          <label style="display:flex;gap:10px;align-items:center;margin:10px 0 14px;font-size:13px;color:#111827">
            <input id="shareHidden" type="checkbox" />
            Gemachtigd (niet zichtbaar in overzicht)
          </label>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px;flex-wrap:wrap">
            <span id="kvSharesCount" class="badge big" title="Aantal shares (van de backend)">-</span>
            <button class="btn" id="btnAddShare" type="button">Add Share</button>
          </div>

          <div style="overflow:auto;border:1px solid var(--border);border-radius:14px">
            <table class="table" id="sharesTable">
              <thead>
                <tr>
                  <th>Tijd</th>
                  <th>Telefoon</th>
                  <th>Commentaar</th>
                  <th>Status</th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="block" id="blockEvents">
          <h4>Events</h4>
          <div id="eventsList" class="muted">Nog geen events geladen</div>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn-ghost" id="btnEvents" type="button">Open events</button>
            <button class="btn-ghost" id="btnPictures" type="button">Open pictures</button>
          </div>
        </div>

        <details class="details" id="detailsBox">
          <summary>
            Details tonen
            <span class="summary-right">minder belangrijk</span>
          </summary>

          <div class="details-body">
            <div class="block" id="blockStatus">
              <h4>Status</h4>

              <div class="kv">
                <div class="muted">Klant</div>
                <div title="organisation.name uit Firestore.">
                  <span id="kvCustomer">-</span><span class="hint">(organisatie)</span>
                </div>

                <div class="muted">Locatie</div>
                <div title="Portal.Site uit Firestore.">
                  <span id="kvSite">-</span><span class="hint">(site)</span>
                </div>

                <div class="muted">Box</div>
                <div title="Portal.BoxNumber uit Firestore.">
                  <span id="kvBox">-</span><span class="hint">(box nr)</span>
                </div>

                <div class="muted">Adres</div>
                <div title="location.street / location.number / location.postalCode / location.city uit Firestore.">
                  <span id="kvAddress">-</span><span class="hint">(adres)</span>
                </div>

                <div class="muted">Actief</div>
                <div title="Portal.active uit Firestore.">
                  <span id="kvActive">-</span><span class="hint">(portaal)</span>
                </div>

                <div class="muted">24/7</div>
                <div title="box.access24h uit Firestore.">
                  <span id="kvAccess24h">-</span><span class="hint">(toegang)</span>
                </div>

                <div class="muted">Type</div>
                <div title="box.type uit Firestore.">
                  <span id="kvType">-</span><span class="hint">(box)</span>
                </div>

                <div class="muted">Beschrijving</div>
                <div title="box.description uit Firestore.">
                  <span id="kvDescription">-</span><span class="hint">(box)</span>
                </div>

                <div class="muted">Lifecycle</div>
                <div title="lifecycle.state uit Firestore.">
                  <span id="kvLifecycleState">-</span><span class="hint">(open of closed)</span>
                </div>

                <div class="muted">Opened</div>
                <div title="lifecycle.openedAt en openedBy.">
                  <span id="kvOpened">-</span><span class="hint">(tijd en nr)</span>
                </div>

                <div class="muted">Closed</div>
                <div title="lifecycle.closedAt en closedBy.">
                  <span id="kvClosed">-</span><span class="hint">(tijd en nr)</span>
                </div>

                <div class="muted">Source</div>
                <div title="lifecycle.source uit Firestore.">
                  <span id="kvSource">-</span><span class="hint">(bv sms)</span>
                </div>

                <div class="muted">Agent</div>
                <div title="Agent of agentVersion.">
                  <span id="kvAgent">-</span><span class="hint">(software)</span>
                </div>

                <div class="muted">Profile</div>
                <div title="Profile of hardwareProfile.">
                  <span id="kvProfile">-</span><span class="hint">(hardware)</span>
                </div>

                <div class="muted">Last seen</div>
                <div title="lastSeenMinutes uit Firestore.">
                  <span id="kvLastSeen">-</span><span class="hint">(laatst online)</span>
                </div>

                <div class="muted">Online</div>
                <div title="Online is recent contact. Offline is langer geen contact.">
                  <span id="kvStatus" class="status-pill">-</span><span class="hint">(verbinding)</span>
                </div>

                <div class="muted">Geo</div>
                <div title="location.geo uit Firestore.">
                  <span id="kvGeo">-</span><span class="hint">(coordinaten)</span>
                </div>
              </div>

              <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn" id="btnOpen" type="button">OPEN</button>
                <button class="btn-ghost" id="btnClose" type="button">CLOSE</button>
              </div>
            </div>

            <div class="block" id="blockPhones">
              <h4>Telefoons</h4>
              <div class="muted" style="font-size:12px;margin:-4px 0 10px;">
                Overzicht gelinkte nummers.
              </div>
              <ul id="sidePhones" class="phone-list">
                <li class="muted">Geen gegevens</li>
              </ul>
            </div>
          </div>
        </details>

      </div>
    </aside>
  </div>

  <div id="backdrop" class="backdrop" aria-hidden="true"></div>

  <script>
    (function(){
      const API_BASE = window.API_BASE || '';
      const LASTSEEN_WARN_MIN = 10;
      const LASTSEEN_BAD_MIN = 60;

      function escapeHtml(s){
        return String(s || '')
          .replaceAll('&','&amp;')
          .replaceAll('<','&lt;')
          .replaceAll('>','&gt;')
          .replaceAll('"','&quot;')
          .replaceAll("'","&#039;");
      }

      function openLink(path){
        const url = (API_BASE || '') + path;
        window.open(url, '_blank', 'noopener');
      }

      function pick(obj, paths){
        for(const p of paths){
          const parts = p.split('.');
          let cur = obj;
          let ok = true;
          for(const part of parts){
            if(cur && Object.prototype.hasOwnProperty.call(cur, part)){
              cur = cur[part];
            } else {
              ok = false; break;
            }
          }
          if(ok && cur !== undefined) return cur;
        }
        return undefined;
      }

      function formatAddress(location){
        if(!location) return '-';
        const street = location.street || location['street '] || '';
        const number = location.number || location['number '] || '';
        const postal = location.postalCode || '';
        const city = location.city || '';
        const a = [street, number].filter(Boolean).join(' ');
        const b = [postal, city].filter(Boolean).join(' ');
        if(!a && !b) return '-';
        return [a,b].filter(Boolean).join(', ');
      }

      function formatGeo(geo){
        if(!geo) return '-';
        const lat = geo._latitude ?? geo.latitude ?? geo.lat;
        const lng = geo._longitude ?? geo.longitude ?? geo.lng;
        if(lat === undefined || lng === undefined) return '-';
        return String(lat) + ', ' + String(lng);
      }

      function formatOpenedClosed(lifecycle, keyAt, keyBy){
        if(!lifecycle) return '-';
        const at = lifecycle[keyAt];
        const by = lifecycle[keyBy];
        const a = at ? String(at) : '';
        const b = by ? String(by) : '';
        if(!a && !b) return '-';
        if(a && b) return a + ' (' + b + ')';
        return a || b;
      }

      function niceState(v){
        if(!v) return '-';
        const s = String(v).toLowerCase();
        if(s === 'open') return 'open';
        if(s === 'closed') return 'closed';
        return String(v);
      }

      const app = document.getElementById('app');
      const side = document.getElementById('side');
      const backdrop = document.getElementById('backdrop');
      const cardsEl = document.getElementById('cards');
      const q = document.getElementById('q');

      const sideTitle = document.getElementById('sideTitle');
      const sideSub   = document.getElementById('sideSub');

      const kvCustomer= document.getElementById('kvCustomer');
      const kvSite    = document.getElementById('kvSite');
      const kvBox     = document.getElementById('kvBox');
      const kvAddress = document.getElementById('kvAddress');

      const kvActive  = document.getElementById('kvActive');
      const kvAccess24h = document.getElementById('kvAccess24h');
      const kvType    = document.getElementById('kvType');
      const kvDescription = document.getElementById('kvDescription');
      const kvLifecycleState = document.getElementById('kvLifecycleState');
      const kvOpened  = document.getElementById('kvOpened');
      const kvClosed  = document.getElementById('kvClosed');
      const kvSource  = document.getElementById('kvSource');

      const kvAgent   = document.getElementById('kvAgent');
      const kvProfile = document.getElementById('kvProfile');

      const kvLastSeen= document.getElementById('kvLastSeen');
      const kvStatus  = document.getElementById('kvStatus');
      const kvGeo     = document.getElementById('kvGeo');

      const kvSharesCount = document.getElementById('kvSharesCount');
      const sidePhones = document.getElementById('sidePhones');

      const ovOnline = document.getElementById('ovOnline');
      const ovLastSeen = document.getElementById('ovLastSeen');
      const ovState = document.getElementById('ovState');
      const ovShares = document.getElementById('ovShares');
      const ovAddress = document.getElementById('ovAddress');

      const sharesStore = {};
      const sharesBody = document.querySelector('#sharesTable tbody');
      const sharePhone = document.getElementById('sharePhone');
      const shareExpires = document.getElementById('shareExpires');
      const shareComment = document.getElementById('shareComment');
      const shareHidden = document.getElementById('shareHidden');

      const eventsList = document.getElementById('eventsList');

      let boxes = [];
      let currentCard = null;

      function isOverlayMode(){
        return !!(window.matchMedia && window.matchMedia('(max-width: 980px)').matches);
      }

      function openSide(){
        side.classList.add('is-open');
        if(isOverlayMode()){
          backdrop.classList.add('is-open');
        }
      }

      function closeSide(){
        side.classList.remove('is-open');
        backdrop.classList.remove('is-open');
      }

      function scrollSideToBlock(id){
        const el = document.getElementById(id);
        if(!el) return;
        el.scrollIntoView({ behavior:'smooth', block:'start' });
      }

      function setStatusPill(card){
        const online = card.getAttribute('data-online');
        const lastMin = Number(card.getAttribute('data-lastseen-min'));
        const state = card.getAttribute('data-state');

        const pill = card.querySelector('.pill-status');
        if(!pill) return;

        let cls = 'pill';
        let txt = 'Onbekend';
        if(online === 'true'){
          cls += ' ok';
          txt = 'Online';
        } else if(online === 'false'){
          cls += ' bad';
          txt = 'Offline';
        } else {
          cls += ' warn';
          txt = 'Onbekend';
        }

        if(Number.isFinite(lastMin)){
          if(lastMin >= LASTSEEN_BAD_MIN){
            cls = 'pill bad';
          } else if(lastMin >= LASTSEEN_WARN_MIN){
            cls = 'pill warn';
          }
        }

        const dot = `<span class="dot"></span>`;
        pill.className = cls + ' pill-status';
        pill.innerHTML = dot + escapeHtml(txt) + (state ? ` <span class="muted" style="margin-left:6px">${escapeHtml(state)}</span>` : '');
      }

      function setBorderByLastSeen(card){
        const min = Number(card.getAttribute('data-lastseen-min'));
        if(!Number.isFinite(min)){
          card.style.borderLeftColor = 'transparent';
          return;
        }
        let color = '#e5e7eb';
        if(min >= LASTSEEN_BAD_MIN) color = getComputedStyle(document.documentElement).getPropertyValue('--bad');
        else if(min >= LASTSEEN_WARN_MIN) color = getComputedStyle(document.documentElement).getPropertyValue('--warn');
        else color = getComputedStyle(document.documentElement).getPropertyValue('--ok');
        card.style.borderLeftColor = color.trim() || color;
      }

      function buildPhonesListHtml(phones){
        const items = Array.isArray(phones) ? phones : [];
        if(!items.length) return '<li class="muted">Geen gegevens</li>';
        return items.map(it=>{
          if(!it) return '';
          const phone = it.phone || it.number || it.msisdn || it;
          const label = it.label || it.type || '';
          const t = label ? `${escapeHtml(phone)} (${escapeHtml(label)})` : escapeHtml(phone);
          return '<li>' + t + '</li>';
        }).join('');
      }

      function updateSharesCountUiFromCard(card){
        if(!kvSharesCount) return;
        const raw = card.getAttribute('data-shares-count');
        if(raw === '' || raw === null || raw === undefined){
          kvSharesCount.textContent = 'shares -';
          return;
        }
        const n = Number(raw);
        if(Number.isNaN(n)){
          kvSharesCount.textContent = 'shares -';
          return;
        }
        kvSharesCount.textContent = 'shares ' + n;
      }

      function setSideStatusPill(online, lastSeenMinutes){
        const dot = '<span class="dot"></span>';
        let cls = 'status-pill';
        let txt = '-';

        if(online === true){
          cls += ' ok';
          txt = 'Online';
        } else if(online === false){
          cls += ' bad';
          txt = 'Offline';
        } else {
          cls += ' warn';
          txt = 'Onbekend';
        }

        if(Number.isFinite(lastSeenMinutes)){
          if(lastSeenMinutes >= LASTSEEN_BAD_MIN){
            cls = 'status-pill bad';
          } else if(lastSeenMinutes >= LASTSEEN_WARN_MIN){
            cls = 'status-pill warn';
          }
        }

        kvStatus.className = cls;
        kvStatus.innerHTML = dot + escapeHtml(txt);
      }

      function renderPhones(card){
        const phonesJson = card.getAttribute('data-phones-json');
        let phones = [];
        try{ phones = phonesJson ? JSON.parse(phonesJson) : []; }catch(e){}
        sidePhones.innerHTML = buildPhonesListHtml(phones);
      }

      function renderShares(boxId){
        sharesBody.innerHTML = '';
        const rows = sharesStore[boxId] || [];
        if(!rows.length){
          const tr = document.createElement('tr');
          tr.innerHTML = '<td class="muted" colspan="5">Geen shares</td>';
          sharesBody.appendChild(tr);
          kvSharesCount.textContent = 'shares -';
          return;
        }
        rows.forEach(row=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(row.createdAt || '-')}</td>
            <td>${escapeHtml(row.phone || '-')}</td>
            <td>${escapeHtml(row.comment || '-')}</td>
            <td>${escapeHtml(row.status || '-')}</td>
            <td style="text-align:right">
              <button class="btn-small" data-share-del="${escapeHtml(row.id || '')}">Del</button>
            </td>
          `;
          sharesBody.appendChild(tr);
        });
        kvSharesCount.textContent = 'shares ' + rows.length;
      }

      async function loadShares(boxId){
        try{
          const res = await fetch((API_BASE||'') + `/api/shares/${encodeURIComponent(boxId)}`);
          const data = await res.json().catch(()=>null);
          sharesStore[boxId] = Array.isArray(data) ? data : [];
        }catch(e){
          sharesStore[boxId] = [];
        }
      }

      async function loadEvents(boxId){
        try{
          const res = await fetch((API_BASE||'') + `/api/boxes/${encodeURIComponent(boxId)}/events`);
          const data = await res.json().catch(()=>null);
          if(!Array.isArray(data) || !data.length){
            eventsList.textContent = 'Nog geen events geladen';
            return;
          }
          eventsList.innerHTML = data.slice(0,10).map(ev=>{
            const t = escapeHtml(ev.time || ev.createdAt || '');
            const type = escapeHtml(ev.type || ev.event || '');
            const msg = escapeHtml(ev.message || ev.info || '');
            return `<div style="padding:6px 0;border-bottom:1px solid var(--border)"><b>${type}</b><div class="muted" style="font-size:12px">${t}</div><div>${msg}</div></div>`;
          }).join('');
        }catch(e){
          eventsList.textContent = 'Nog geen events geladen';
        }
      }

      function updateOverviewFromCard(card){
        const onlineRaw = card.getAttribute('data-online');
        const lastSeen = card.getAttribute('data-lastseen-min');
        const state = card.getAttribute('data-state');
        const address = card.getAttribute('data-address');
        const sharesRaw = card.getAttribute('data-shares-count');

        let onlineTxt = '-';
        if(onlineRaw === 'true') onlineTxt = 'Online';
        else if(onlineRaw === 'false') onlineTxt = 'Offline';
        else onlineTxt = 'Onbekend';

        let lastTxt = '-';
        if(lastSeen !== '' && lastSeen !== null && lastSeen !== undefined){
          lastTxt = String(lastSeen) + ' min geleden';
        }

        let sharesTxt = '-';
        if(sharesRaw !== '' && sharesRaw !== null && sharesRaw !== undefined){
          const n = Number(sharesRaw);
          sharesTxt = Number.isNaN(n) ? '-' : (String(n));
        }

        ovOnline.textContent = onlineTxt;
        ovLastSeen.textContent = lastTxt;
        ovState.textContent = niceState(state);
        ovShares.textContent = sharesTxt;
        ovAddress.textContent = address || '-';
      }

      function updateSideFromCard(card, subtitle){
        currentCard = card;

        const site = card.getAttribute('data-site') || '-';
        const boxNumber = card.getAttribute('data-boxnumber') || '-';

        sideTitle.textContent = site + ' #' + boxNumber;
        sideSub.textContent = subtitle || 'Beheer en overzicht';

        kvCustomer.textContent = card.getAttribute('data-customer') || '-';
        kvSite.textContent = site;
        kvBox.textContent = '# ' + boxNumber;

        kvAddress.textContent = card.getAttribute('data-address') || '-';

        kvActive.textContent = card.getAttribute('data-active') || '-';
        kvAccess24h.textContent = card.getAttribute('data-access24h') || '-';
        kvType.textContent = card.getAttribute('data-type') || '-';
        kvDescription.textContent = card.getAttribute('data-description') || '-';

        kvLifecycleState.textContent = card.getAttribute('data-state') || '-';
        kvOpened.textContent = card.getAttribute('data-opened') || '-';
        kvClosed.textContent = card.getAttribute('data-closed') || '-';
        kvSource.textContent = card.getAttribute('data-source') || '-';

        kvAgent.textContent = card.getAttribute('data-agent') || '-';
        kvProfile.textContent = card.getAttribute('data-profile') || '-';

        const lastSeen = card.getAttribute('data-lastseen-min');
        kvLastSeen.textContent = (lastSeen === '' || lastSeen === null) ? '-' : (String(lastSeen) + ' min geleden');

        const onlineRaw = card.getAttribute('data-online');
        const online = (onlineRaw === 'true') ? true : ((onlineRaw === 'false') ? false : null);
        const lastSeenMin = Number(lastSeen);
        setSideStatusPill(online, Number.isFinite(lastSeenMin) ? lastSeenMin : null);

        kvGeo.textContent = card.getAttribute('data-geo') || '-';

        setStatusPill(card);
        renderPhones(card);

        const bId = card.getAttribute('data-id');
        renderShares(bId);

        updateSharesCountUiFromCard(card);
        updateOverviewFromCard(card);

        openSide();
      }

      function selectCard(card){
        document.querySelectorAll('.gb-card.is-selected').forEach(x=>x.classList.remove('is-selected'));
        card.classList.add('is-selected');
      }

      function renderBoxes(){
        const term = (q.value || '').trim().toLowerCase();
        cardsEl.innerHTML = '';
        const filtered = !term ? boxes : boxes.filter(b=>{
          const s = JSON.stringify(b).toLowerCase();
          return s.includes(term);
        });

        filtered.forEach(box=>{
          const card = document.createElement('article');
          card.className = 'gb-card';

          const id = box.id ?? '-';

          const customer = pick(box, ['organisation.name','Portal.Customer','customer','Customer']) ?? '-';
          const site = pick(box, ['Portal.Site','site','portal.site']) ?? '-';
          const boxNumber = pick(box, ['Portal.BoxNumber','boxNumber','portal.boxNumber','box.number']) ?? '-';

          const active = pick(box, ['Portal.active','Portal.Active','active']) ?? null;
          const access24h = pick(box, ['box.access24h','box.access24H','access24h']) ?? null;
          const type = pick(box, ['box.type','type','box.type ']) ?? null;
          const description = pick(box, ['box.description','description']) ?? null;

          const lifecycleState = pick(box, ['lifecycle.state','status','state']) ?? null;
          const openedAt = pick(box, ['lifecycle.openedAt','openedAt']) ?? null;
          const openedBy = pick(box, ['lifecycle.openedBy','openedBy']) ?? null;
          const closedAt = pick(box, ['lifecycle.closedAt','closedAt']) ?? null;
          const closedBy = pick(box, ['lifecycle.closedBy','closedBy']) ?? null;
          const source = pick(box, ['lifecycle.source','source']) ?? null;

          const online = pick(box, ['online']) ?? null;
          const lastSeenMinutes = pick(box, ['lastSeenMinutes','lastSeenMin']) ?? null;

          const agentVersion = pick(box, ['agentVersion','Agent','agent']) ?? null;
          const hardwareProfile = pick(box, ['hardwareProfile','Profile','profile']) ?? null;

          const location = box.location ?? {};
          const address = formatAddress(location);
          const geo = formatGeo(location.geo);

          const sharesCountRaw = pick(box, ['sharesCount','shares_count']) ?? null;
          const sharesCount = (sharesCountRaw === null || sharesCountRaw === undefined) ? null : Number(sharesCountRaw);

          card.setAttribute('data-id', id);
          card.setAttribute('data-customer', customer || '-');
          card.setAttribute('data-site', site || '-');
          card.setAttribute('data-boxnumber', boxNumber === null ? '-' : String(boxNumber));

          card.setAttribute('data-address', address || '-');
          card.setAttribute('data-geo', geo || '-');

          card.setAttribute('data-active', (active === null || active === undefined) ? '-' : (active ? 'ja' : 'nee'));
          card.setAttribute('data-access24h', (access24h === null || access24h === undefined) ? '-' : (access24h ? 'ja' : 'nee'));
          card.setAttribute('data-type', type ? String(type).trim() : '-');
          card.setAttribute('data-description', description ? String(description) : '-');

          card.setAttribute('data-state', lifecycleState ? String(lifecycleState) : '-');
          card.setAttribute('data-opened', formatOpenedClosed({ openedAt, openedBy }, 'openedAt','openedBy'));
          card.setAttribute('data-closed', formatOpenedClosed({ closedAt, closedBy }, 'closedAt','closedBy'));
          card.setAttribute('data-source', source ? String(source) : '-');

          card.setAttribute('data-online', (online === true) ? 'true' : ((online === false) ? 'false' : ''));
          card.setAttribute('data-lastseen-min', (lastSeenMinutes === null || lastSeenMinutes === undefined) ? '' : String(lastSeenMinutes));

          card.setAttribute('data-agent', agentVersion ? String(agentVersion) : '-');
          card.setAttribute('data-profile', hardwareProfile ? String(hardwareProfile) : '-');

          const phones = pick(box, ['phones','Portal.phones','portal.phones']) ?? [];
          card.setAttribute('data-phones-json', JSON.stringify(phones || []));

          card.setAttribute('data-shares-count', (sharesCount === null || Number.isNaN(sharesCount)) ? '' : String(sharesCount));

          const stateTxt = lifecycleState ? String(lifecycleState) : '';
          if(stateTxt.toLowerCase() === 'open') card.classList.add('is-open');

          const sharesPill = (sharesCount === null || Number.isNaN(sharesCount))
            ? `<span class="pill ghost" title="sharesCount">shares -</span>`
            : `<span class="pill ghost" title="sharesCount">shares ${escapeHtml(String(sharesCount))}</span>`;

          card.innerHTML = `
            <div class="gb-icon" aria-hidden="true">
              <div class="gb-shutter"><div class="gb-shutter__door"></div></div>
            </div>
            <div>
              <div class="gb-title">
                <h3>${escapeHtml(site)} #${escapeHtml(String(boxNumber))}</h3>
                <span class="pill pill-status"><span class="dot"></span> -</span>
              </div>
              <div class="gb-meta">
                <span class="pill ghost" title="boxId">${escapeHtml(id)}</span>
                <span class="pill ghost" title="klant">${escapeHtml(customer)}</span>
                ${sharesPill}
              </div>
              <div class="card-actions">
                <button class="btn-small" data-action="manage">Beheer</button>
                <button class="btn-small" data-action="shares">Shares</button>
                <button class="btn-small" data-action="events">Events</button>
                <button class="btn-small" data-action="pictures">Pictures</button>
              </div>
            </div>
          `;

          setStatusPill(card);
          setBorderByLastSeen(card);

          card.addEventListener('click', ()=>{
            selectCard(card);
            updateSideFromCard(card, 'Beheer en overzicht');
          });

          cardsEl.appendChild(card);
        });

        if(currentCard){
          const id = currentCard.getAttribute('data-id');
          const still = document.querySelector(`.gb-card[data-id="${CSS.escape(id)}"]`);
          if(still){
            currentCard = still;
            selectCard(still);
          }
        }
      }

      async function fetchBoxes(){
        const res = await fetch((API_BASE || '') + '/api/boxes');
        if(!res.ok) throw new Error('API /api/boxes faalde');
        return res.json();
      }

      async function sendCommand(boxId, cmd){
        const res = await fetch((API_BASE || '') + `/api/boxes/${encodeURIComponent(boxId)}/${cmd}`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({})
        });
        if(!res.ok){
          const t = await res.text().catch(()=> '');
          throw new Error('Command faalde: ' + res.status + ' ' + t);
        }
        return res.json().catch(()=> ({}));
      }

      async function addShare(boxId, payload){
        const res = await fetch((API_BASE || '') + `/api/shares/${encodeURIComponent(boxId)}`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload || {})
        });
        if(!res.ok){
          const t = await res.text().catch(()=> '');
          throw new Error('Add share faalde: ' + res.status + ' ' + t);
        }
        return res.json().catch(()=> ({}));
      }

      async function deleteShare(boxId, shareId){
        const res = await fetch((API_BASE || '') + `/api/shares/${encodeURIComponent(boxId)}/${encodeURIComponent(shareId)}`,{
          method:'DELETE'
        });
        if(!res.ok){
          const t = await res.text().catch(()=> '');
          throw new Error('Delete share faalde: ' + res.status + ' ' + t);
        }
        return res.json().catch(()=> ({}));
      }

      document.getElementById('btnCloseSide').addEventListener('click', closeSide);
      backdrop.addEventListener('click', closeSide);

      document.getElementById('btnCollapse').addEventListener('click', ()=>{
        side.classList.remove('is-wide');
        app.classList.remove('is-expanded');
        app.classList.add('is-collapsed');
      });

      document.getElementById('btnExpand').addEventListener('click', ()=>{
        app.classList.remove('is-collapsed');
        app.classList.add('is-expanded');
      });

      document.getElementById('btnToggleWide').addEventListener('click', ()=>{
        side.classList.toggle('is-wide');
      });

      q.addEventListener('input', renderBoxes);

      document.getElementById('btnGoShares').addEventListener('click', ()=>{
        if(!currentCard) return alert('Selecteer eerst een Gridbox links.');
        updateSideFromCard(currentCard, 'Toegang beheren');
        setTimeout(()=>scrollSideToBlock('blockShares'), 0);
      });

      document.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button[data-action]');
        const card = e.target.closest('.gb-card');
        if(!card) return;

        if(btn){
          const action = btn.getAttribute('data-action');

          if(action === 'manage'){
            e.preventDefault(); e.stopPropagation();
            selectCard(card);
            updateSideFromCard(card, 'Beheer en overzicht');
            return;
          }

          if(action === 'shares'){
            e.preventDefault(); e.stopPropagation();
            selectCard(card);
            updateSideFromCard(card, 'Toegang beheren');
            setTimeout(()=>scrollSideToBlock('blockShares'), 0);
            return;
          }

          if(action === 'events'){
            e.preventDefault(); e.stopPropagation();
            selectCard(card);
            updateSideFromCard(card, 'Events');
            setTimeout(()=>scrollSideToBlock('blockEvents'), 0);
            const boxId = card.getAttribute('data-id');
            if(boxId && boxId !== '-') loadEvents(boxId);
            return;
          }

          if(action === 'pictures'){
            e.preventDefault(); e.stopPropagation();
            updateSideFromCard(card, 'Beheer en overzicht');
            const boxId = card.getAttribute('data-id');
            if (boxId && boxId !== '-') openLink(`/api/boxes/${encodeURIComponent(boxId)}/pictures`);
            return;
          }
        }

        updateSideFromCard(card, 'Beheer en overzicht');
      });

      document.getElementById('btnOpen').addEventListener('click', async ()=>{
        if(!currentCard) return alert('Selecteer eerst een Gridbox links.');
        const boxId = currentCard.getAttribute('data-id');
        const ok = confirm('Box openen?');
        if(!ok) return;

        try{
          await sendCommand(boxId, 'open');
          currentCard.classList.add('is-open');
          updateSideFromCard(currentCard, 'Beheer en overzicht');
        } catch(err){
          alert('OPEN mislukt: ' + (err && err.message ? err.message : err));
        }
      });

      document.getElementById('btnClose').addEventListener('click', async ()=>{
        if(!currentCard) return alert('Selecteer eerst een Gridbox links.');
        const boxId = currentCard.getAttribute('data-id');
        const ok = confirm('Box sluiten?');
        if(!ok) return;

        try{
          await sendCommand(boxId, 'close');
          currentCard.classList.remove('is-open');
          updateSideFromCard(currentCard, 'Beheer en overzicht');
        } catch(err){
          alert('CLOSE mislukt: ' + (err && err.message ? err.message : err));
        }
      });

      const btnOpenTop = document.getElementById('btnOpenTop');
      const btnCloseTop = document.getElementById('btnCloseTop');
      if(btnOpenTop){
        btnOpenTop.addEventListener('click', ()=>{
          const b = document.getElementById('btnOpen');
          if(b) b.click();
        });
      }
      if(btnCloseTop){
        btnCloseTop.addEventListener('click', ()=>{
          const b = document.getElementById('btnClose');
          if(b) b.click();
        });
      }

      document.getElementById('btnEvents').addEventListener('click', ()=>{
        if(!currentCard) return alert('Selecteer eerst een Gridbox links.');
        const boxId = currentCard.getAttribute('data-id');
        if (boxId && boxId !== '-') openLink(`/api/boxes/${encodeURIComponent(boxId)}/events`);
      });

      document.getElementById('btnPictures').addEventListener('click', ()=>{
        if(!currentCard) return alert('Selecteer eerst een Gridbox links.');
        const boxId = currentCard.getAttribute('data-id');
        if (boxId && boxId !== '-') openLink(`/api/boxes/${encodeURIComponent(boxId)}/pictures`);
      });

      document.getElementById('btnAddShare').addEventListener('click', async ()=>{
        if(!currentCard) return alert('Selecteer eerst een Gridbox links.');
        const boxId = currentCard.getAttribute('data-id');

        const phone = (sharePhone.value || '').trim();
        const expiresAt = (shareExpires.value || '').trim();
        const comment = (shareComment.value || '').trim();
        const hidden = !!shareHidden.checked;

        if(!phone) return alert('Telefoon is verplicht.');

        try{
          await addShare(boxId, { phone, expiresAt, comment, hidden });
          await loadShares(boxId);
          renderShares(boxId);

          const n = (sharesStore[boxId] || []).length;
          if(currentCard) currentCard.setAttribute('data-shares-count', String(n));
          updateSharesCountUiFromCard(currentCard);
          updateOverviewFromCard(currentCard);

          sharePhone.value = '';
          shareExpires.value = '';
          shareComment.value = '';
          shareHidden.checked = false;
        }catch(err){
          alert('Add share mislukt: ' + (err && err.message ? err.message : err));
        }
      });

      sharesBody.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button[data-share-del]');
        if(!btn) return;
        if(!currentCard) return;
        const shareId = btn.getAttribute('data-share-del');
        if(!shareId) return;

        const ok = confirm('Share verwijderen?');
        if(!ok) return;

        try{
          const boxId = currentCard.getAttribute('data-id');
          await deleteShare(boxId, shareId);
          await loadShares(boxId);
          renderShares(boxId);

          const n = (sharesStore[boxId] || []).length;
          currentCard.setAttribute('data-shares-count', String(n));
          updateSharesCountUiFromCard(currentCard);
          updateOverviewFromCard(currentCard);
        }catch(err){
          alert('Delete share mislukt: ' + (err && err.message ? err.message : err));
        }
      });

      async function boot(){
        try{
          boxes = await fetchBoxes();

          for(const b of boxes){
            const id = b.id;
            if(!id) continue;
            await loadShares(id);
            const n = (sharesStore[id] || []).length;

            try{
              b.sharesCount = n;
            }catch(e){}
          }

          renderBoxes();

          if(boxes && boxes.length){
            const first = document.querySelector('.gb-card');
            if(first){
              selectCard(first);
              updateSideFromCard(first, 'Beheer en overzicht');
            }
          }
        }catch(err){
          cardsEl.innerHTML = `<div class="muted" style="padding:16px">Kon boxen niet laden: ${escapeHtml(err && err.message ? err.message : err)}</div>`;
        }
      }

      boot();
    })();
  </script>
</body>
</html>
