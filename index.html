<!DOCTYPE html>

<script type="text/plain" id="worknotes">
  Deze versie (V20 - FINAL FULL FIX) bevat:
  1. FIX: updateSharesCountUiFromLocal functie hersteld (lost referentiefout op).
  2. FIX: Delete knop roept nu de API aan (DELETE request).
  3. FIX: Add Share roept nu de API aan (POST request).
  4. FIX: Fetch Shares haalt data van de server (GET request).
  5. FIX: Auto-refresh en Camera/Events logica behouden.
  Datum: 2026-01-12
-->
</script>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gridbox Portal v1</title>

  <style>
    /* =========================================================
       CSS OVERZICHT
       1) Design tokens
       2) Base
       3) Layout
       4) Toolbar
       5) Cards + pills
       6) Side panel
       7) Tabellen en formulieren
       8) Responsive
       9) Animaties (Heartbeat)
       ========================================================= */
    /* 1) Design tokens */

    :root{
      --primary:#6d28d9;
      --ok:#22c55e;
      --warn:#eab308;
      --bad:#ef4444;

      --bg:#f8fafc;
      --panel:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;

      --border:#e5e7eb;

      --chip:#f4eefe;

      --shadow:0 2px 10px rgba(0,0,0,.08);
      --radius:16px;
      
      /* Theme upgrade overrides */
      --brand:#2563eb;
      --brand2:#0ea5e9;
    }

    /* 2) Base */

    *{box-sizing:border-box}
    body{
      margin:0;
      background: linear-gradient(180deg, var(--bg), #ffffff 60%);
      color:var(--ink);
      font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,'Helvetica Neue',Arial;
    }

    body.lock-scroll{
      overflow:hidden;
      touch-action:none;
    }

    /* 3) Layout */

    .app{
      display:grid;
      grid-template-columns: 1fr 560px;
      min-height:100vh;
    }
    .app.is-collapsed{ grid-template-columns: 1fr 360px; }
    .app.is-expanded{ grid-template-columns: 1fr 760px; }

    .main{
      padding:18px 18px 28px;
      overflow:auto;
      border-right:1px solid #f1f5f9;
    }

    /* 4) Toolbar */

    .toolbar{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:14px;
      
      position: sticky;
      top: 0;
      z-index: 20;

      background: rgba(255,255,255,.92);
      backdrop-filter: saturate(150%) blur(6px);

      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
    }
    
    .toolbar::before{
      content: "";
      position: absolute;
      left: -1px;
      right: -1px;
      top: -1px;
      height: 3px;
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      background: linear-gradient(90deg, var(--brand), var(--brand2));
    }

    .brand{
      font-weight:800;
      font-size:20px;
      letter-spacing:.3px;
      white-space:nowrap;
      background: linear-gradient(90deg, var(--brand), var(--brand2));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    
    .brand::after{
      content: "index";
      display: inline-block;
      margin-left: 10px;
      font-size: 12px;
      font-weight: 800;
      color: #1e3a8a;
      background: #eff6ff;
      border: 1px solid #dbeafe;
      padding: 4px 8px;
      border-radius: 999px;
      vertical-align: middle;
    }

    .toolbar__right{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    #customerFilter,#locationFilter,#search{
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      font:inherit;
      box-shadow: 0 6px 14px rgba(15,23,42,.04);
    }
    #search{min-width:260px}
    
    select:focus, input:focus{
      outline: none;
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12), 0 6px 14px rgba(15,23,42,.04);
    }

    /* 5) Cards + pills */

    .gb-section{margin-bottom:20px}
    .gb-section__title{
      font-weight:800;
      margin:10px 0 10px 4px;
      font-size:18px;
      position: relative;
    }
    
    .gb-section__title::after{
      content: "";
      position: absolute;
      left: 0;
      bottom: -6px;
      width: 120px;
      height: 3px;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--brand), var(--brand2));
      opacity: .9;
    }
    
    .gb-list{display:grid;gap:12px}

    .gb-card{
      display:grid;
      grid-template-columns:64px 1fr auto;
      gap:12px;
      align-items:stretch;
      background:#fff;
      border:1px solid #eee;
      border-left:6px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:12px;
      cursor:pointer;
      transition: transform .08s ease, box-shadow .15s ease, background .15s ease, outline-color .15s ease;
    }
    .gb-card:hover{
      transform: translateY(-1px);
      box-shadow: 0 16px 34px rgba(15,23,42,.10);
    }
    .gb-card.is-selected{
      outline:3px solid var(--primary);
      outline-offset:2px;
      background:#faf7ff;
      box-shadow:0 6px 20px rgba(109,40,217,.18);
    }


    .gb-shutter{
      position:relative;
      width:56px;height:56px;
      border-radius:12px;
      background:#f3f4f6;
      overflow:hidden;
      box-shadow:inset 0 0 0 1px var(--border);
      cursor:default;
    }
    .gb-shutter__door{
      position:absolute;
      inset:0;
      background-image:url('https://gridbox.eu/images/f5b43959-ec7d-4fbe-9a38-1324a9617cf3_biss.png');
      background-repeat:repeat-y;
      background-size:100% auto;
      transition:transform 25s cubic-bezier(.2,.7,.2,1);
      transform:translateY(0);
    }
    .gb-card.is-open .gb-shutter__door{ transform:translateY(-100%); }

    .gb-head{
      display:grid;
      grid-template-columns:1fr auto auto;
      gap:8px;
      align-items:center;
      margin-bottom:6px;
    }
    .gb-site{font-weight:800; font-size:16px}
    .gb-box{font-weight:800;color:#111827}
    /* Aangepast voor icoon uitlijning */
    .gb-time{
      font-size:.85rem;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:6px;
      margin-left: auto; /* Duwt tijd naar rechts */
    }

    .gb-meta{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      margin:6px 0 0;
    }

    .pill{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--border);
      background:#f8fafc;
      color:#111827;
      white-space:nowrap;
    }
    .pill.ok{border-color:#bbf7d0;background:#f0fdf4}
    .pill.warn{border-color:#fde68a;background:#fffbeb}
    .pill.bad{border-color:#fecaca;background:#fef2f2}
    .pill .dot{width:8px;height:8px;border-radius:99px;background:#94a3b8;flex:0 0 auto}
    .pill.ok .dot{background:var(--ok)}
    .pill.warn .dot{background:var(--warn)}
    .pill.bad .dot{background:var(--bad)}
    .pill.ghost{background:#fff;border-style:dashed;color:var(--muted)}

    .gb-phones{
      margin:10px 0 0;
      padding-left:18px;
      color:#111827;
    }
    .gb-phones li{line-height:1.35}

    .gb-actions{
      display:grid;
      grid-template-rows:auto auto;
      gap:8px;
      min-width:240px;
      align-items:start;
      justify-items:stretch;
      cursor:default;
    }
    .gb-actions .gb-row{
      display:flex;
      gap:8px;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .btn,.btn-ghost{
      border-radius:12px;
      padding:10px 12px;
      border:1px solid var(--border);
      cursor:pointer;
      font:inherit;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn{
      background: linear-gradient(90deg, var(--brand), var(--brand2));
      color:#fff;
      border:none;
      box-shadow: 0 10px 18px rgba(37,99,235,.18);
    }
    .btn:active{transform:translateY(1px)}
    .btn-ghost{
      background: #fff;
      color: var(--ink);
      box-shadow: 0 10px 18px rgba(15,23,42,.06);
    }
    .btn-ghost:hover{filter:brightness(.98)}

    .btn-small{
      padding:9px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: linear-gradient(90deg, var(--brand), var(--brand2));
      color:#fff;
      cursor:pointer;
      font:inherit;
    }
    .btn-small.btn-ghost{
      background:var(--chip);
      color:inherit;
    }

    .right{display:flex;justify-content:flex-end}
    .muted{color:var(--muted)}

    .badge{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid #ddd;
      font-size:11px;
      color:#6b7280;
      background:#f3f4f6;
      white-space:nowrap;
    }

    .side{
      background:var(--panel);
      overflow:auto;
      box-shadow:-10px 0 30px rgba(0,0,0,.08);
      border-left:1px solid #f1f5f9;
    }

    /* 6) Side panel */

    .side-header{
      position:sticky;
      top:0;
      z-index:5;
      background: rgba(255,255,255,.92);
      backdrop-filter: saturate(150%) blur(6px);
      border-bottom:1px solid #f1f5f9;
      padding:14px 14px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }

    .side-title{font-weight:800;font-size:16px;margin:0}
    .side-sub{color:var(--muted);font-size:12px;margin-top:2px}

    .side-actions{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .side-body{padding:14px 14px 18px}

    .block{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:#fff;
      margin-bottom:12px;
    }
    .block h4{margin:0 0 10px;font-size:14px}

    .chip{
      display:inline-block;
      background:#eef2ff;
      border:1px solid #e0e7ff;
      color:#3730a3;
      border-radius:999px;
      padding:2px 8px;
      font-size:.75rem;
    }

    .kv{
      display:grid;
      grid-template-columns:140px 1fr;
      gap:8px;
      font-size:13px;
    }
    .kv div{padding:3px 0}

    .status-pill{
      display:inline-block;
      border-radius:999px;
      padding:4px 10px;
      font-size:12px;
      border:1px solid var(--border);
      background:#f8fafc;
    }
    .status-pill.ok{border-color:#bbf7d0;background:#f0fdf4}
    .status-pill.warn{border-color:#fde68a;background:#fffbeb}
    .status-pill.bad{border-color:#fecaca;background:#fef2f2}

    .hint{
      color:var(--muted);
      font-size:12px;
      margin-left:6px;
      white-space:nowrap;
    }

    .form-row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-bottom:10px;
    }

    .field{display:flex;flex-direction:column;gap:6px}
    .field input,.field textarea{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      background:#fff;
      font:inherit;
    }
    .field label{font-weight:700;color:#111827;font-size:12px}
    .check{display:flex;align-items:center;gap:8px;margin:8px 0 0}



    /* =========================================================
       EXTRA: 2 LAGEN RECHTERPANEEL
       Laag 1 = Samenvatting
       Laag 2 = Details
       ========================================================= */

    .side-body .layer2{ display:none; }
    .side-body.show-details .layer2{ display:block; }

    .summary-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }

    .alert{
      display:none;
      border:1px solid var(--border);
      background:#f8fafc;
      border-radius:14px;
      padding:10px;
      margin-bottom:10px;
      font-size:13px;
    }
    .alert.ok{ border-color:#bbf7d0; background:#f0fdf4; }
    .alert.warn{ border-color:#fde68a; background:#fffbeb; }
    .alert.bad{ border-color:#fecaca; background:#fef2f2; }

    /* 7) Tabellen en formulieren */

    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th{
      font-weight:700;
      text-align:left;
      color:var(--muted);
      font-size:12px;
      padding:0 8px;
      white-space:nowrap;
    }
    td{
      background:#fff;
      border:1px solid var(--border);
      padding:10px 8px;
      vertical-align:top;
      font-size:13px;
    }
    td:first-child{
      border-top-left-radius:12px;
      border-bottom-left-radius:12px;
      width:150px;
      color:var(--muted);
      white-space:nowrap;
    }
    td:last-child{
      border-top-right-radius:12px;
      border-bottom-right-radius:12px;
    }

    .phone-list{margin:0;padding-left:16px}
    .phone-list li{margin:6px 0;color:#111827}

    #btnCloseSide{display:none;}

    .backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.35);
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease;
      z-index:40;
    }
    .backdrop.is-open{opacity:1;pointer-events:auto}

    .access-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .access-left{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .access-title{
      font-weight:800;
      font-size:14px;
      color:#111827;
    }
    .access-sub{
      color:var(--muted);
      font-size:12px;
    }
    .access-right{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .badge.big{
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      background:#fff;
      border:1px solid var(--border);
      color:#111827;
    }

    /* 8) Responsive */

    @media (max-width: 980px){
      .app, .app.is-collapsed, .app.is-expanded{ grid-template-columns: 1fr; }

      .side{
        position:fixed;
        top:0;right:0;bottom:0;
        width:min(92vw,720px);
        transform:translateX(110%);
        transition:transform .24s ease;
        z-index:50;
      }
      .side.is-open{ transform:translateX(0); }
      .side.is-wide{ width:100vw; }

      #btnCloseSide{
        display:inline-flex;
        align-items:center;
        justify-content:center;
      }

      .form-row{grid-template-columns:1fr}
    }

    @media (max-width: 640px){
      .main{ padding:14px 14px 24px; }

      .toolbar{flex-direction:column;align-items:flex-start;gap:10px}
      .toolbar__right{width:100%;justify-content:flex-start}

      #customerFilter,#locationFilter{width:calc(50% - 5px)}
      #search{min-width:0;width:100%}

      .gb-card{grid-template-columns:64px 1fr;grid-template-rows:auto auto}
      .gb-actions{grid-column:1 / -1;min-width:0;grid-template-rows:auto}
      .gb-actions .btn{width:100%}
      .gb-actions .gb-row{width:100%;display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
      .gb-actions .gb-row .btn-ghost{width:100%;padding:10px 8px}

      .gb-head{grid-template-columns:1fr auto}
      .gb-time{grid-column:1 / -1}

      .gb-phones{display:none}
      .pill{padding:4px 9px}
    }

    /* 9) Animaties (Heartbeat) */
    .pulse-heart {
      display: inline-block;
      vertical-align: middle;
      width: 24px;
      height: 24px;
      fill: #cbd5e1; /* Default grey/dead */
      margin-right: 4px;
      transition: fill 0.3s;
    }
    
    .pulse-heart.alive {
      fill: #ef4444; /* Red */
      animation: heartPulse 1s infinite ease-in-out; /* 1s (1000ms) interval */
    }

    

    .pulse-heart.warn{
      fill: #f59e0b; /* Orange warning */
      animation: none;
    }
@keyframes heartPulse {
      0% { transform: scale(1); }
      15% { transform: scale(1.25); }
      30% { transform: scale(1); }
      45% { transform: scale(1.15); }
      60% { transform: scale(1); }
      100% { transform: scale(1); }
    }
  </style>
</head>

<body>
    <div id="app" class="app is-collapsed">
    <main class="main">
      <div class="toolbar">
        <div class="brand">Gridbox</div>

        <div class="toolbar__right">
          <select id="customerFilter" aria-label="Klant filter">
            <option value="all">Alle klanten</option>
          </select>

          <select id="locationFilter" aria-label="Locatie filter">
            <option value="all">Alle locaties</option>
          </select>

          <input id="search" type="search" placeholder="Zoek op box, site of telefoon..." aria-label="Zoeken"/>
        </div>
      </div>

      <div id="sections" aria-live="polite"></div>
    </main>

    <aside id="side" class="side" aria-label="Detail">
      <div class="side-header">
        <div>
          <div class="side-title" id="sideTitle">Selecteer een Gridbox</div>
          <div class="side-sub" id="sideSub">Tik op een kaart links</div>
        </div>
        <div class="side-actions">
          <button id="btnCollapse" class="btn-ghost" type="button" title="Smaller">Smaller</button>
          <button id="btnExpand" class="btn-ghost" type="button" title="Breder">Breder</button>
          <button id="btnCloseSide" class="btn" type="button" title="Sluiten">Sluiten</button>
        </div>
      </div>

      <div class="side-body">

        <div class="block" id="blockSummary">
          <h4>Samenvatting</h4>

          <div id="kvAlert" class="alert" role="status" aria-live="polite"></div>

          <div class="kv">
            <div class="muted">Nu</div>
            <div><span id="kvNowState">-</span><span id="kvNowSince" class="hint"></span></div>

            <div class="muted">Bevestiging</div>
            <div><span id="kvNowConfirm">-</span><span class="hint">(sensor of timing)</span></div>

            <div class="muted">Gewenst</div>
            <div><span id="kvDesired">-</span><span id="kvDesiredMeta" class="hint"></span></div>

            <div class="muted">Laatste actie</div>
            <div><span id="kvLastAction">-</span><span id="kvLastActionMeta" class="hint"></span></div>

            <div class="muted">Verbinding</div>
            <div><span id="kvConn">-</span><span id="kvConnMeta" class="hint"></span></div>

            <div class="muted">Toegang</div>
            <div><span id="kvAccessSummary">-</span></div>
          </div>

          <div class="summary-actions">
            <button class="btn-ghost" id="btnToggleDetails" type="button">Meer details</button>
          </div>

          <div style="margin-top:10px">
            <span class="chip">Beheeractie wordt gelogd als portaal</span>
          </div>
        </div>

        <div class="block" id="blockAccess">
          <h4>Toegang</h4>
          <div class="access-row">
            <div class="access-left">
              <div class="access-title">Shares</div>
              <div class="access-sub">Beheer wie toegang heeft tot deze box.</div>
            </div>
            <div class="access-right">
              <span id="kvSharesCount" class="badge big" title="Aantal shares (van de backend)">shares -</span>
              <button id="btnGoShares" class="btn-small" type="button">Shares beheren</button>
            </div>
          </div>
        </div>

        <div class="block layer2" id="blockShares">
          <h4>Shares</h4>

          <div class="form-row">
            <div class="field">
              <label for="sharePhone">Telefoon</label>
              <input id="sharePhone" placeholder="+32..." inputmode="tel" />
            </div>
            <div class="field">
              <label for="shareExpires">Vervalt op</label>
              <input id="shareExpires" placeholder="bv 19/12/2025 22:00" />
            </div>
          </div>

          <div class="field" style="margin-bottom:10px">
            <label for="shareComment">Commentaar</label>
            <input id="shareComment" placeholder="bv Afhaling..." />
          </div>

          <label class="check">
            <input type="checkbox" id="shareAuth"/>
            <span>Gemachtigd (niet zichtbaar in overzicht)</span>
          </label>

          <div class="right" style="margin:12px 0">
            <button id="shareAdd" class="btn-small" type="button">Add Share</button>
          </div>

          <div style="overflow:auto">
            <table id="sharesTable" aria-label="Shares tabel">
              <thead>
                <tr>
                  <th>Tijd</th>
                  <th>Telefoon</th>
                  <th>Commentaar</th>
                  <th>Status</th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="block layer2" id="blockStatus">
          <h4>Details</h4>

          <div class="kv">
            <div class="muted">Klant</div>
            <div title="De organisatie die deze box beheert.">
              <span id="kvCustomer">-</span><span class="hint">(organisatie)</span>
            </div>

            <div class="muted">Locatie</div>
            <div title="De plaats waar deze Gridbox staat.">
              <span id="kvSite">-</span><span class="hint">(site)</span>
            </div>

            <div class="muted">Box</div>
            <div title="Het nummer van deze Gridbox binnen de locatie.">
              <span id="kvBox">-</span><span class="hint">(box nr)</span>
            </div>

            <div class="muted">Adres</div>
            <div title="Adres waar de Gridbox staat.">
              <span id="kvAddress">-</span><span class="hint">(adres)</span>
            </div>

            <div class="muted">Actief</div>
            <div title="Portal.active uit Firestore.">
              <span id="kvActive">-</span><span class="hint">(portal)</span>
            </div>

            <div class="muted">24/7</div>
            <div title="box.access24h uit Firestore.">
              <span id="kvAccess24h">-</span><span class="hint">(toegang)</span>
            </div>

            <div class="muted">Type</div>
            <div title="box.type uit Firestore.">
              <span id="kvType">-</span><span class="hint">(box)</span>
            </div>

            <div class="muted">Beschrijving</div>
            <div title="box.description uit Firestore.">
              <span id="kvDescription">-</span><span class="hint">(box)</span>
            </div>

            <div class="muted">Lifecycle</div>
            <div title="lifecycle.state uit Firestore.">
              <span id="kvLifecycleState">-</span><span class="hint">(open of closed)</span>
            </div>

            <div class="muted">Opened</div>
            <div title="lifecycle.openedAt en openedBy.">
              <span id="kvOpened">-</span><span class="hint">(tijd en nr)</span>
            </div>

            <div class="muted">Closed</div>
            <div title="lifecycle.closedAt en closedBy.">
              <span id="kvClosed">-</span><span class="hint">(tijd en nr)</span>
            </div>

            <div class="muted">Source</div>
            <div title="lifecycle.source uit Firestore.">
              <span id="kvSource">-</span><span class="hint">(bv sms)</span>
            </div>

            <div class="muted">Agent</div>
            <div title="Versie of naam van de controller software in deze box.">
              <span id="kvAgent">-</span><span class="hint">(software)</span>
            </div>

            <div class="muted">Profile</div>
            <div title="Hardwareprofiel (aansluitingen).">
              <span id="kvProfile">-</span><span class="hint">(hardware)</span>
            </div>

            <div class="muted">Last seen</div>
            <div title="Laatste contact van de box controller.">
              <span id="kvSeen">-</span><span class="hint">(laatst online)</span>
            </div>

            <div class="muted">Online</div>
            <div title="Online is recent contact. Offline is langer geen contact.">
              <span id="kvStatus" class="status-pill">-</span><span class="hint">(verbinding)</span>
            </div>

            <div class="muted">Geo</div>
            <div title="location.geo uit Firestore.">
              <span id="kvGeo">-</span><span class="hint">(coordinaten)</span>
            </div>
          </div>
        </div>

        <div class="block layer2" id="blockPhones">
          <h4>Telefoons</h4>
          <div class="muted" style="font-size:12px;margin:-4px 0 10px;">
            Overzicht gelinkte nummers.
          </div>
          <ul id="sidePhones" class="phone-list">
            <li class="muted">Geen gegevens</li>
          </ul>
        </div>

        <div class="block layer2" id="blockEvents">
          <h4>Events</h4>
          <div id="eventsList" class="muted">Nog geen events geladen</div>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn-ghost" id="btnEvents" type="button">Open events</button>
            <button class="btn-ghost" id="btnPictures" type="button">Open pictures</button>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <div id="backdrop" class="backdrop" aria-hidden="true"></div>

  <script>
    (function(){

      // =========================================================
      // 1) Config en helpers
      // =========================================================
      const API_BASE = "";

      const apiUrl = (path) => {
        const base = (API_BASE || "").replace(/\/$/,"");
        return base + path;
      };

      

      // =========================================================
      // 1b) Pending acties (geen fake open/close, wel "verzonden")
      // =========================================================
      const PENDING_KEY_PREFIX = 'gb_pending_';
      const PENDING_TTL_MS = 2 * 60 * 1000; // 2 minuten

      const pendingMem = new Map();

      function setPending(boxId, desired){
        const v = { desired, ts: Date.now() };
        pendingMem.set(String(boxId), v);
        try { localStorage.setItem(PENDING_KEY_PREFIX + String(boxId), JSON.stringify(v)); } catch(_) {}
      }

      function clearPending(boxId){
        pendingMem.delete(String(boxId));
        try { localStorage.removeItem(PENDING_KEY_PREFIX + String(boxId)); } catch(_) {}
      }

      function getPending(boxId){
        const key = String(boxId);
        const m = pendingMem.get(key);
        if (m && Date.now() - m.ts <= PENDING_TTL_MS) return m;

        try{
          const raw = localStorage.getItem(PENDING_KEY_PREFIX + key);
          if(!raw) return null;
          const v = JSON.parse(raw);
          if(!v || !v.ts || Date.now() - v.ts > PENDING_TTL_MS){
            localStorage.removeItem(PENDING_KEY_PREFIX + key);
            return null;
          }
          return v;
        } catch(_){
          return null;
        }
      }

      // =========================================================
      // 1c) Fast follow-up na OPEN/CLOSE (zodat het meteen aanvoelt)
      // =========================================================
      const FAST_POLL_START_MS = 400;
      const FAST_POLL_MAX_MS = 45000;
      const FAST_POLL_STEP_MS = 150;
      const fastWatch = new Map(); // boxId -> timeoutId

      async function fetchBoxById(boxId){
        const boxes = await loadBoxes();
        return (boxes || []).find(b => String(b.id) === String(boxId)) || null;
      }

      function replaceCardInDomFromBox(box){
        if(!box || !box.id) return;
        const boxId = String(box.id);
        const old = document.querySelector('.gb-card[data-id="' + boxId + '"]');
        if(!old) return;

        const wasSelected = old.classList.contains('is-selected');
        const wasCurrent = (currentCard && currentCard.getAttribute('data-id') === boxId);

        const newCard = createCard(box);
        if(!newCard) return;

        if(wasSelected) newCard.classList.add('is-selected');
        old.replaceWith(newCard);

        if(wasCurrent){
          currentCard = newCard;
          if(side.classList.contains('is-open')){
            const currentTitle = (document.getElementById('sideSub') || {}).textContent || '';
            updateSideFromCard(newCard, currentTitle, { silent:true });
          }
        }
      }

      function stopFastWatch(boxId){
        const key = String(boxId);
        const t = fastWatch.get(key);
        if(t) clearTimeout(t);
        fastWatch.delete(key);
      }

      function startFastWatch(boxId){
        const key = String(boxId);
        stopFastWatch(key);

        const startedAt = Date.now();
        let delay = FAST_POLL_START_MS;

        const tick = async ()=>{
          const elapsed = Date.now() - startedAt;
          if(elapsed > FAST_POLL_MAX_MS){
            stopFastWatch(key);
            return;
          }

          try{
            const box = await fetchBoxById(key);
            if(box){
              replaceCardInDomFromBox(box);

              const motion = normalizeShutterStateDetailed(pickMotionState(box));
              const door = normalizeShutterStateDetailed(pickDoorState(box));
              const pend = getPending(key);

              if(pend){
                const wantDoor = (pend.desired === 'open') ? 'open' : 'closed';
                const moving = (motion === 'opening' || motion === 'closing');

                if(door === wantDoor && !moving){
                  clearPending(key);
                  stopFastWatch(key);
                  return;
                }
              }
            }
          } catch(_){}

          delay = Math.min(delay + FAST_POLL_STEP_MS, 1200);
          fastWatch.set(key, setTimeout(tick, delay));
        };

        fastWatch.set(key, setTimeout(tick, delay));
      }

      async function refreshOneBoxNow(boxId){
        try{
          const box = await fetchBoxById(boxId);
          if(box) replaceCardInDomFromBox(box);
        } catch(_){}
      }
// =========================================================
      // 2) DOM refs en state
      // =========================================================

      const app = document.getElementById('app');
      const side = document.getElementById('side');
      const backdrop = document.getElementById('backdrop');

      const sideBody = document.querySelector('.side-body');

      const sectionsWrap = document.getElementById('sections');

      // =========================================================
      // 3) Side panel open/sluit
      // =========================================================

      function isOverlayMode(){
        return !!(window.matchMedia && window.matchMedia('(max-width: 980px)').matches);
      }

      function openSide(){
        side.classList.add('is-open');
        if (isOverlayMode()){
          backdrop.classList.add('is-open');
          document.body.classList.add('lock-scroll');
        }
      }

      function closeSide(){
        side.classList.remove('is-open');
        backdrop.classList.remove('is-open');
        document.body.classList.remove('lock-scroll');

        side.classList.remove('is-wide');
        app.classList.remove('is-expanded');
      }

      backdrop.addEventListener('click', closeSide);
      document.getElementById('btnCloseSide').addEventListener('click', closeSide);

      document.getElementById('btnCollapse').addEventListener('click', ()=>{
        side.classList.remove('is-wide');
        app.classList.remove('is-expanded');
        app.classList.add('is-collapsed');
      });

      document.getElementById('btnExpand').addEventListener('click', ()=>{
        app.classList.remove('is-collapsed');
        app.classList.add('is-expanded');
      });

      window.addEventListener('resize', ()=>{
        if (!isOverlayMode()){
          backdrop.classList.remove('is-open');
          document.body.classList.remove('lock-scroll');
          side.classList.remove('is-open');
        }
      });

      document.addEventListener('keydown', (ev)=>{
        if(ev.key === 'Escape') closeSide();
      });

      let touchStartX = null, touchStartY = null;
      side.addEventListener('touchstart', (e)=>{
        const t = e.touches && e.touches[0];
        if(!t) return;
        touchStartX = t.clientX;
        touchStartY = t.clientY;
      }, { passive:true });

      side.addEventListener('touchend', (e)=>{
        const t = e.changedTouches && e.changedTouches[0];
        if(!t || touchStartX === null) return;
        const dx = t.clientX - touchStartX;
        const dy = t.clientY - touchStartY;
        if (dx > 70 && Math.abs(dy) < 60) closeSide();
        touchStartX = null; touchStartY = null;
      }, { passive:true });

      function computeOnlineStateFromMinutes(min){
        // Als we geen lastSeen hebben, is de status niet per se 'slecht', 
        // maar we weten het gewoon niet live. We geven 'unknown' terug (grijs).
        if (min === null || Number.isNaN(min)) return { label:'-', cls:'' };
        if (min <= 2) return { label:'Online', cls:'ok' };
        if (min <= 10) return { label:'Opgelet', cls:'warn' };
        return { label:'Offline', cls:'bad' };
      }

      // Helper om tijdsverloop tekstueel te maken (bv "2 dagen geleden")
      function fmtTimeAgo(min) {
        if (min === null || Number.isNaN(min)) return '';
        if (min < 1) return 'zojuist';
        if (min < 60) return min + ' min. geleden';
        const uren = Math.floor(min / 60);
        if (uren < 24) return uren + ' uur geleden';
        const dagen = Math.floor(uren / 24);
        if (dagen < 30) return dagen + ' dagen geleden';
        const maanden = Math.floor(dagen / 30);
        return maanden + ' maanden geleden';
      }

      function fmtMaybe(v){
        if (v === null || v === undefined || v === '') return '-';
        if (typeof v === 'object'){
          if (v.name !== undefined) return String(v.name);
          if (v.code !== undefined) return String(v.code);
          if (v.number !== undefined) return String(v.number);
          return '-';
        }
        return String(v);
      }

      function pick(obj, paths){
        for (const p of paths){
          const parts = p.split('.');
          let cur = obj;
          let ok = true;
          for (const part of parts){
            if (cur && Object.prototype.hasOwnProperty.call(cur, part)){
              cur = cur[part];
            } else {
              ok = false;
              break;
            }
          }
          if (ok && cur !== undefined) return cur;
        }
        return undefined;
      }

      function normalizeShutterStateDetailed(v){
        const s = String(v ?? '').trim().toLowerCase();
        if (!s) return '';
        if (s === 'open' || s === 'opened') return 'open';
        if (s === 'opening') return 'opening';
        if (s === 'closed' || s === 'close') return 'closed';
        if (s === 'closing') return 'closing';
        return s;
      }

      function shutterLabel(state){
        const s = String(state ?? '').trim().toLowerCase();
        if (s === 'open') return 'OPEN';
        if (s === 'closed') return 'CLOSED';
        if (s === 'opening') return 'OPENING';
        if (s === 'closing') return 'CLOSING';
        return 'UNKNOWN';
      }

      
      // Tijd parsing voor "since/timestamp/updatedAt" velden (Firestore/ISO/ms)
      function parseAnyTime(v){
        try{
          if (v === null || v === undefined) return null;
          if (typeof v === 'number' && isFinite(v)){
            // ms of seconds
            return v > 1e12 ? v : Math.round(v * 1000);
          }
          if (typeof v === 'string'){
            // Probeer ISO string
            const t = Date.parse(v);
            return isNaN(t) ? null : t;
          }
          if (typeof v === 'object'){
            // Firestore Timestamp {seconds, nanoseconds} of {_seconds, _nanoseconds}
            const sec = (v.seconds !== undefined) ? v.seconds : (v._seconds !== undefined ? v._seconds : null);
            const nsec = (v.nanoseconds !== undefined) ? v.nanoseconds : (v._nanoseconds !== undefined ? v._nanoseconds : 0);
            if (sec !== null && sec !== undefined){
              const ms = Number(sec) * 1000 + Math.floor(Number(nsec || 0) / 1e6);
              return isFinite(ms) ? ms : null;
            }
          }
          return null;
        } catch(_){
          return null;
        }
      }

      function pickMotionSince(box){
        return pick(box, [
          'state.since',
          'lifecycle.since',
          'status.timestamp',
          'state.timestamp',
          'status.updatedAt',
          'updatedAt'
        ]) ?? null;
      }

      function isRecent(tsVal, maxMs){
        const ms = parseAnyTime(tsVal);
        if (!ms) return false;
        return Math.abs(Date.now() - ms) <= maxMs;
      }

function mainButtonLabel(doorState, motionState, fallbackIsOpen){
        const d =
          normalizeShutterStateDetailed(doorState) ||
          (fallbackIsOpen ? 'open' : 'closed');

        // UI toont enkel acties, geen tussenstates
        if (d === 'open') return 'CLOSE';
        return 'OPEN';
      }

      // Bewegingsstatus (meestal "opening/closing") komt typisch uit state.state
      function pickMotionState(box){
        return pick(box, [
          'state.state',
          'lifecycle.state',
          'lifecycle.status',
          'lifecycleState',
          'shutterState',
          'state'
        ]) ?? null;
      }

      // Deurstatus (meestal "open/closed") komt typisch uit status.door of status.state
      function pickDoorState(box){
        return pick(box, [
          'status.door',
          'status.state',
          'lifecycle.door',
          'door',
          'shutter.door',
          'shutter.state'
        ]) ?? null;
      }

      function pickCustomer(box){
        return pick(box, [
          'Portal.Customer',
          'portal.customer',
          'organisation.name',
          'organization.name',
                    'Portal.Organisation',
                    'Portal.Organization',
                    'portal.organisation',
                    'portal.organization',
          'customer'
        ]) ?? null;
      }

      function pickSite(box){
        return pick(box, [
          'Portal.Site',
          'portal.site',
          'site.name',
          'site.code',
          'site'
        ]) ?? null;
      }

      function pickBoxNumber(box){
        return pick(box, [
          'Portal.BoxNumber',
          'portal.boxNumber',
          'box.number',
          'boxNumber'
        ]) ?? null;
      }

      function pickActive(box){
        const v = pick(box, ['Portal.active','portal.active','active']);
        if (v === true) return 'ja';
        if (v === false) return 'nee';
        return fmtMaybe(v);
      }

      function pickAccess24h(box){
        const v = pick(box, ['box.access24h','box.access_24h','access24h','Portal.access24h','portal.access24h']);
        if (v === true) return 'ja';
        if (v === false) return 'nee';
        return fmtMaybe(v);
      }

      function pickBoxType(box){
        return pick(box, ['box.type','Portal.type','portal.type','type','hardwareProfile','Profile','profile']) ?? null;
      }

      function pickBoxDescription(box){
        return pick(box, ['box.description','Portal.description','portal.description','description']) ?? null;
      }

      function pickLifecycleState(box){
        return pick(box, ['lifecycle.state','lifecycle.status','state','status']) ?? null;
      }

      function pickLifecycleOpenedAt(box){
        return pick(box, ['lifecycle.openedAt','lifecycle.opened_at','openedAt']) ?? null;
      }

      function pickLifecycleOpenedBy(box){
        return pick(box, ['lifecycle.openedBy','lifecycle.opened_by','openedBy']) ?? null;
      }

      function pickLifecycleClosedAt(box){
        return pick(box, ['lifecycle.closedAt','lifecycle.closed_at','closedAt']) ?? null;
      }

      function pickLifecycleClosedBy(box){
        return pick(box, ['lifecycle.closedBy','lifecycle.closed_by','closedBy']) ?? null;
      }

      function pickLifecycleSource(box){
        return pick(box, ['lifecycle.source','source']) ?? null;
      }

      function pickDesired(box){
        return pick(box, [
          'desired',
          'data.desired',
          'box.desired',
          'Portal.desired',
          'portal.desired'
        ]) ?? null;
      }

      function pickDesiredAt(box){
        return pick(box, [
          'desiredAt',
          'data.desiredAt',
          'data.desired_at',
          'desired_at',
          'box.desiredAt'
        ]) ?? null;
      }

      function pickDesiredBy(box){
        return pick(box, [
          'desiredBy',
          'data.desiredBy',
          'data.desired_by',
          'desired_by',
          'box.desiredBy'
        ]) ?? null;
      }

      function pickGeo(box){
        const v = pick(box, ['location.geo','location.geopoint','location.geoPoint','geo','geoPoint']);
        if (!v) return null;
        if (typeof v === 'string') return v;
        if (typeof v === 'object'){
          const lat = v.latitude ?? v._latitude;
          const lng = v.longitude ?? v._longitude;
          if (lat !== undefined && lng !== undefined) return `${lat}, ${lng}`;
        }
        return fmtMaybe(v);
      }

      function pickAgent(box){
        return pick(box, [
          'Agent',
          'agent',
          'agent.version',
          'agentVersion',
          'softwareVersion'
        ]) ?? null;
      }

      function pickProfile(box){
        return pick(box, [
          'Profile',
          'profile',
          'hardwareProfile',
          'box.type'
        ]) ?? null;
      }

      function buildAddressFromBox(box){
        const street = pick(box, ['location.street']) ?? '';
        const number = pick(box, ['location.number']) ?? '';
        const postCode = pick(box, ['location.postalCode','location.postCode','location.postcode']) ?? '';
        const city = pick(box, ['location.city']) ?? '';

        let line1 = `${street} ${number}`.trim();
        let line2 = `${postCode} ${city}`.trim();

        if (!line1 && !line2) return '';
        if (line1 && line2) return `${line1}, ${line2}`;
        return line1 || line2;
      }

      function fmtLastSeen(min){
        if (min === null || min === undefined) return '-';
        const n = Number(min);
        if (Number.isNaN(n)) return '-';
        return n + ' min geleden';
      }

      function escapeHtml(s){
        return String(s || '')
          .replace(/&/g,'&amp;')
          .replace(/</g,'&lt;')
          .replace(/>/g,'&gt;')
          .replace(/"/g,'&quot;')
          .replace(/'/g,'&#39;');
      }

      function setBorderByLastSeen(card){
        const min = Number(card.getAttribute('data-lastseen-min'));
        const s = computeOnlineStateFromMinutes(min);
        let color = getComputedStyle(document.documentElement).getPropertyValue('--bad').trim();
        if (s.cls === 'ok') color = getComputedStyle(document.documentElement).getPropertyValue('--ok').trim();
        else if (s.cls === 'warn') color = getComputedStyle(document.documentElement).getPropertyValue('--warn').trim();
        card.style.borderLeftColor = color;
      }

      function buildPhonesListHtml(phones){
        if (!phones || !Array.isArray(phones) || !phones.length){
          return '<li class="muted">Geen nummers</li>';
        }
        return phones.map(p=>{
          const phone = escapeHtml(p.phone || '');
          const label = escapeHtml(p.label || '');
          if (!phone) return '';
          return `<li><span title="${label}">${phone}</span></li>`;
        }).join('');
      }

      function buildPhonesDataAttr(phones){
        if (!phones || !Array.isArray(phones) || !phones.length) return '';
        return phones
          .map(p => `${(p.phone||'').trim()}|${(p.label||'').trim()}`)
          .filter(Boolean)
          .join(',');
      }

      // =========================================================
      // 4) Rendering cards en sections
      // =========================================================

      function createCard(box){
        if (box && box.ui && box.ui.hidden === true) return null;

        const id = fmtMaybe(box.id);

        const customer = pickCustomer(box);
        const customerText = fmtMaybe(customer);
        const sitePicked = pickSite(box);
        const boxNrPicked = pickBoxNumber(box);

        const site = fmtMaybe(sitePicked);
        const boxNumber = fmtMaybe(boxNrPicked);

        const agent = pickAgent(box);
        const profile = pickProfile(box);

        const lastSeen = pick(box, ['lastSeenMinutes','last_seen_minutes','lastSeen']) ?? null;
        const lastSeenNum = (lastSeen === null || lastSeen === undefined) ? NaN : Number(lastSeen);
        const s = computeOnlineStateFromMinutes(lastSeenNum);

        // NIEUWE LOGICA: Bepaal de meest recente activiteit (Action)
        // 1. Haal timestamps op
        const tOpen = parseAnyTime(pickLifecycleOpenedAt(box)) || 0;
        const tClose = parseAnyTime(pickLifecycleClosedAt(box)) || 0;
        // Als lastSeenNum geldig is, rekenen we dat om naar een timestamp (ongeveer)
        const tSeen = (!isNaN(lastSeenNum) && lastSeenNum !== null) ? (Date.now() - lastSeenNum*60000) : 0;

        // 2. Zoek de grootste (meest recente)
        let maxTs = Math.max(tOpen, tClose, tSeen);
        
        let lastActionText = 'Geen info';
        let lastSeenHeader = '-';
        // ============================================================

        if (maxTs > 0) {
          const diffMin = Math.floor((Date.now() - maxTs) / 60000);
          const timeStr = fmtTimeAgo(diffMin);

          // Voor de Pill (Actie)
          if (maxTs === tOpen) {
            lastActionText = 'Geopend ' + timeStr;
          } else if (maxTs === tClose) {
            lastActionText = 'Gesloten ' + timeStr;
          } else if (maxTs === tSeen) {
            lastActionText = 'Gezien ' + timeStr;
          } else {
            // Fallback (bv lokale actie of maxTs was updated)
            // Als we lokaal hebben geupdate, is het meestal Open of Close
            // Maar we weten de state niet 100% zeker hier zonder complexere logica
            // We gebruiken de timeStr
             if (localRaw && JSON.parse(localRaw).ts === maxTs) {
                 const state = JSON.parse(localRaw).state;
                 lastActionText = (state === 'open' ? 'Geopend ' : 'Gesloten ') + timeStr;
             } else {
                 lastActionText = timeStr;
             }
          }
        }
        
        // Voor de Header (Laatst gezien)
        // Alleen de ECHTE lastSeen gebruiken (geen open/close/local)
        if (lastSeenNum !== null && !isNaN(lastSeenNum)) {
             lastSeenHeader = fmtLastSeen(lastSeenNum);
        }


        // Pending actie (commando verzonden, wachten op box)
        const pending = getPending(id);
        if (pending){
          lastActionText = (pending.desired === 'open' ? 'Open gevraagd' : 'Dicht gevraagd') + ' zojuist';
        }
        // ===========================================================
        // HEADER HEARTBEAT (Kloppend hartje)
        // Enkel op basis van lastSeen (echte verbinding)
        // - alive: <= 2 min
        // - warn : 2-10 min
        // - dead : > 10 min of onbekend
        let heartClass = '';

        if (lastSeenNum !== null && !isNaN(lastSeenNum)) {
          if (lastSeenNum <= 2) heartClass = 'alive';
          else if (lastSeenNum <= 10) heartClass = 'warn';
        }

        const heartIcon = `
          <svg class="pulse-heart ${heartClass}" viewBox="0 0 24 24">
            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
          </svg>
        `;

        const sharesCountRaw = pick(box, ['sharesCount','shares_count']) ?? null;
        const sharesCount = (sharesCountRaw === null || sharesCountRaw === undefined) ? null : Number(sharesCountRaw);

        const phones = Array.isArray(box.phones) ? box.phones : [];
        const phonesAttr = buildPhonesDataAttr(phones);
        const phonesHtml = buildPhonesListHtml(phones);

        const address = buildAddressFromBox(box);

        const active = pickActive(box);
        const access24h = pickAccess24h(box);
        const bType = fmtMaybe(pickBoxType(box));
        const bDesc = fmtMaybe(pickBoxDescription(box));
        const lcState = fmtMaybe(pickLifecycleState(box));
        const openedAt = fmtMaybe(pickLifecycleOpenedAt(box));
        const openedBy = fmtMaybe(pickLifecycleOpenedBy(box));
        const closedAt = fmtMaybe(pickLifecycleClosedAt(box));
        const closedBy = fmtMaybe(pickLifecycleClosedBy(box));
        const lcSource = fmtMaybe(pickLifecycleSource(box));
        const geo = fmtMaybe(pickGeo(box));

        const desiredRaw = pickDesired(box);
        const desiredNorm = normalizeDesiredValue(desiredRaw);
        const desiredAt = fmtMaybe(pickDesiredAt(box));
        const desiredBy = fmtMaybe(pickDesiredBy(box));

        const card = document.createElement('article');
        card.className = 'gb-card';

        const rawShutterState =
  pick(box, [
    'status.shutterState',
    'shutterState',
    'state.shutterState'
  ]) ??
  pickMotionState(box) ??
  pickDoorState(box);

const shutterState = normalizeShutterStateDetailed(rawShutterState);

const motionState =
  shutterState === 'opening' || shutterState === 'closing'
    ? shutterState
    : '';

const doorState =
  shutterState === 'open' || shutterState === 'closed'
    ? shutterState
    : '';

        if (motionState === 'opening') {
          card.classList.add('is-open');
        } else if (motionState === 'closing') {
          card.classList.remove('is-open');
        } else if (doorState === 'open') {
          card.classList.add('is-open');
        } else if (doorState === 'closed') {
          card.classList.remove('is-open');
        }

        card.setAttribute('data-motion-state', motionState);
        card.setAttribute('data-door-state', doorState);
        card.setAttribute('data-shutter-state', doorState || motionState);
        
        card.setAttribute('data-id', id);
        card.setAttribute('data-site', site === '-' ? '' : site);
        card.setAttribute('data-box', boxNumber === '-' ? '' : boxNumber);
        card.setAttribute('data-agent', agent ?? '');
        card.setAttribute('data-profile', profile ?? '');
        card.setAttribute('data-lastseen-min', (lastSeen === null || lastSeen === undefined) ? '' : String(lastSeen));
        card.setAttribute('data-phones', phonesAttr);

        card.setAttribute('data-customer', customer ?? '');
        card.setAttribute('data-address', address ?? '');

        card.setAttribute('data-active', active ?? '');
        card.setAttribute('data-access24h', access24h ?? '');
        card.setAttribute('data-type', bType ?? '');
        card.setAttribute('data-desc', bDesc ?? '');
        card.setAttribute('data-lifecycle-state', lcState ?? '');
        card.setAttribute('data-opened-at', openedAt ?? '');
        card.setAttribute('data-opened-by', openedBy ?? '');
        card.setAttribute('data-closed-at', closedAt ?? '');
        card.setAttribute('data-closed-by', closedBy ?? '');
        card.setAttribute('data-source', lcSource ?? '');
        card.setAttribute('data-geo', geo ?? '');


        card.setAttribute('data-desired', desiredNorm || '');
        card.setAttribute('data-desired-at', desiredAt ?? '');
        card.setAttribute('data-desired-by', desiredBy ?? '');

        card.setAttribute('data-shares-count', (sharesCount === null || Number.isNaN(sharesCount)) ? '' : String(sharesCount));

        const toggleLabel = mainButtonLabel(doorState, motionState, card.classList.contains('is-open'));

        const sharesPill = (sharesCount === null || Number.isNaN(sharesCount))
          ? `<span class="pill ghost" title="sharesCount">shares -</span>`
          : `<span class="pill ghost" title="sharesCount">shares ${escapeHtml(String(sharesCount))}</span>`;

        // UPDATE: Header nu met hartje, geen tekst
        card.innerHTML = `
          <div class="gb-shutter" aria-hidden="true"><div class="gb-shutter__door"></div></div>

          <div>
            <div class="gb-head">
              <div class="gb-site">${escapeHtml(site)}</div>
              <div class="gb-box"># ${escapeHtml(boxNumber)}</div>
              <div class="gb-time js-header-time" title="Laatst gezien">${heartIcon} <span>${escapeHtml(lastSeenHeader)}</span></div>
            </div>

            <div class="gb-meta">
              <span class="pill ghost" title="Klant"><span class="dot"></span><span>${escapeHtml(customerText)}</span></span>
              <span class="pill ${s.cls}" title="Laatste handeling"><span class="dot"></span><span class="js-status-text">${escapeHtml(lastActionText)}</span></span>
              <span class="pill ghost" title="Portal.active">active ${escapeHtml(active || '-')}</span>
              <span class="pill ghost" title="box.access24h">24/7 ${escapeHtml(access24h || '-')}</span>
              <span class="pill ghost" title="box.type">${escapeHtml(bType || '-')}</span>
              ${sharesPill}
            </div>

            <ul class="gb-phones">
              ${phonesHtml}
            </ul>
          </div>

          <div class="gb-actions">
            <button class="btn" data-action="toggle" type="button">${toggleLabel}</button>
            <div class="gb-row">
              <button class="btn-ghost" data-action="events" type="button">EVENTS</button>
              <button class="btn-ghost" data-action="shares" type="button">SHARES</button>
              <button class="btn-ghost" data-action="pictures" type="button">PICTURES</button>
            </div>
          </div>
        `;

        setBorderByLastSeen(card);
        return card;
      }

      function groupBoxesIntoSections(boxes){
        const map = new Map();
        boxes.forEach(b=>{
          const siteVal = pickSite(b) ?? 'Onbekend';
          const site = String(siteVal);
          if (!map.has(site)) map.set(site, []);
          map.get(site).push(b);
        });
        return map;
      }

      function renderSectionsFromBoxes(boxes){
        sectionsWrap.innerHTML = '';

        boxes = (boxes || []).filter(b => !(b && b.ui && b.ui.hidden === true));

        if (!boxes || !boxes.length){
          sectionsWrap.innerHTML = `<div class="muted">Geen gridboxen gevonden</div>`;
          rebuildFilters();
          return;
        }

        const grouped = groupBoxesIntoSections(boxes);

        [...grouped.entries()].forEach(([site, items])=>{
          const sec = document.createElement('section');
          sec.className = 'gb-section';
          sec.setAttribute('data-group', site);

          const customer = (items[0] && pickCustomer(items[0])) ? String(pickCustomer(items[0])) : '';
          sec.setAttribute('data-customer', customer);

          sec.innerHTML = `
            <h3 class="gb-section__title">${escapeHtml(site)}</h3>
            <div class="gb-list"></div>
          `;

          const list = sec.querySelector('.gb-list');
          items.forEach(b=>{
            const card = createCard(b);
            if (card) list.appendChild(card);
          });

          sectionsWrap.appendChild(sec);
        });

        rebuildFilters();
        applyFilters();
      }

      // =========================================================
      // 5) API calls
      // =========================================================

      async function loadBoxes(){
        const res = await fetch(apiUrl('/api/boxes'), { method:'GET' });
        if (!res.ok){
          const t = await res.text().catch(()=> '');
          throw new Error('API fout: ' + res.status + ' ' + t);
        }
        const data = await res.json().catch(()=> []);
        return Array.isArray(data) ? data : [];
      }

      async function setDesired(boxId, desired){
        const res = await fetch(apiUrl(`/api/boxes/${encodeURIComponent(boxId)}/desired`), {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({
            desired,
            desiredAt: new Date().toISOString(),
            desiredBy: 'portal'
          })
        });
        if(!res.ok){
          const t = await res.text().catch(()=>'');
          throw new Error('Desired fout: ' + t);
        }
      }

      async function sendCommand(boxId, type){
        const url = apiUrl(`/api/boxes/${encodeURIComponent(boxId)}/${type}`);
        const res = await fetch(url, { method:'POST' });
        const payload = await res.json().catch(()=> ({}));
        if (!res.ok || !payload || payload.ok !== true){
          throw new Error(payload.error || 'Interne serverfout');
        }
        return payload;
      }

      function openLink(path){
        const url = apiUrl(path);
        window.open(url, '_blank', 'noopener');
      }

      const customerFilter = document.getElementById('customerFilter');
      const locationFilter = document.getElementById('locationFilter');
      const search = document.getElementById('search');

      function getSections(){
        return [...document.querySelectorAll('.gb-section')];
      }
      function getCustomerOfSection(sec){ return (sec.getAttribute('data-customer') || '').trim(); }
      function getLocationOfSection(sec){ return (sec.getAttribute('data-group') || '').trim(); }

      // =========================================================
      // 6) Filters
      // =========================================================

      function rebuildCustomerDropdown(){
        const sections = getSections();
        const customers = [...new Set(sections.map(getCustomerOfSection))].filter(Boolean).sort();
        const current = customerFilter.value;

        customerFilter.innerHTML = '<option value="all">Alle klanten</option>';
        customers.forEach(c=>{
          const o=document.createElement('option');
          o.value=c; o.textContent=c;
          customerFilter.appendChild(o);
        });

        const stillExists = [...customerFilter.options].some(opt => opt.value === current);
        customerFilter.value = stillExists ? current : 'all';
      }

      function rebuildLocationDropdown(){
        const sections = getSections();
        const selectedCustomer = customerFilter.value;

        const locations = sections
          .filter(sec => selectedCustomer === 'all' || getCustomerOfSection(sec) === selectedCustomer)
          .map(getLocationOfSection).filter(Boolean);

        const uniq = [...new Set(locations)].sort();

        const current = locationFilter.value;
        locationFilter.innerHTML = '<option value="all">Alle locaties</option>';
        uniq.forEach(loc=>{
          const o=document.createElement('option');
          o.value=loc; o.textContent=loc;
          locationFilter.appendChild(o);
        });

        const stillExists = [...locationFilter.options].some(opt => opt.value === current);
        locationFilter.value = stillExists ? current : 'all';
      }

      function matchesSearch(card, term){
        if(!term) return true;
        term = term.toLowerCase();
        const site = (card.getAttribute('data-site')||'').toLowerCase();
        const box  = (card.getAttribute('data-box')||'').toLowerCase();
        const addr = (card.getAttribute('data-address')||'').toLowerCase();
        const text = card.innerText.toLowerCase();
        return site.includes(term) || box.includes(term) || addr.includes(term) || text.includes(term);
      }

      function applyFilters(){
        const c = customerFilter.value;
        const loc = locationFilter.value;
        const term = search.value.trim();

        const sections = getSections();
        const cards = [...document.querySelectorAll('.gb-card')];

        cards.forEach(card=>{
          const sec = card.closest('.gb-section');
          const secCustomer = getCustomerOfSection(sec);
          const secLocation = getLocationOfSection(sec);

          const show =
            (c === 'all' || secCustomer === c) &&
            (loc === 'all' || secLocation === loc) &&
            matchesSearch(card, term);

          card.style.display = show ? '' : 'none';
        });

        sections.forEach(sec=>{
          const visible = [...sec.querySelectorAll('.gb-card')].some(x => x.style.display !== 'none');
          sec.style.display = visible ? '' : 'none';
        });
      }

      function rebuildFilters(){
        rebuildCustomerDropdown();
        rebuildLocationDropdown();
      }

      customerFilter.addEventListener('change', ()=>{
        rebuildLocationDropdown();
        applyFilters();
      });
      locationFilter.addEventListener('change', applyFilters);
      search.addEventListener('input', applyFilters);

      let currentCard = null;

      const sideTitle = document.getElementById('sideTitle');
      const sideSub   = document.getElementById('sideSub');

      const kvCustomer= document.getElementById('kvCustomer');
      const kvSite    = document.getElementById('kvSite');
      const kvBox     = document.getElementById('kvBox');
      const kvAddress = document.getElementById('kvAddress');

      const kvActive  = document.getElementById('kvActive');
      const kvAccess24h = document.getElementById('kvAccess24h');
      const kvType    = document.getElementById('kvType');
      const kvDescription = document.getElementById('kvDescription');
      const kvLifecycleState = document.getElementById('kvLifecycleState');
      const kvOpened  = document.getElementById('kvOpened');
      const kvClosed  = document.getElementById('kvClosed');
      const kvSource  = document.getElementById('kvSource');
      const kvGeo     = document.getElementById('kvGeo');

      const kvAgent   = document.getElementById('kvAgent');
      const kvProfile = document.getElementById('kvProfile');
      const kvSeen    = document.getElementById('kvSeen');
      const kvStatus  = document.getElementById('kvStatus');

      const kvSharesCount = document.getElementById('kvSharesCount');

      const kvAlert = document.getElementById('kvAlert');
      const kvNowState = document.getElementById('kvNowState');
      const kvNowSince = document.getElementById('kvNowSince');
      const kvNowConfirm = document.getElementById('kvNowConfirm');
      const kvDesired = document.getElementById('kvDesired');
      const kvDesiredMeta = document.getElementById('kvDesiredMeta');
      const kvLastAction = document.getElementById('kvLastAction');
      const kvLastActionMeta = document.getElementById('kvLastActionMeta');
      const kvConn = document.getElementById('kvConn');
      const kvConnMeta = document.getElementById('kvConnMeta');
      const kvAccessSummary = document.getElementById('kvAccessSummary');

      const btnToggleDetails = document.getElementById('btnToggleDetails');

      const sidePhones = document.getElementById('sidePhones');

      // Details toggle (laag 2)
      const DETAILS_KEY = 'gb_side_show_details';

      function setDetailsOpen(open){
        if(!sideBody || !btnToggleDetails) return;
        const v = !!open;
        sideBody.classList.toggle('show-details', v);
        btnToggleDetails.textContent = v ? 'Minder details' : 'Meer details';
        try { localStorage.setItem(DETAILS_KEY, v ? '1' : '0'); } catch(_) {}
      }

      function initDetailsToggle(){
        let start = false;
        try { start = localStorage.getItem(DETAILS_KEY) === '1'; } catch(_) {}
        setDetailsOpen(start);
        btnToggleDetails.addEventListener('click', ()=>{
          setDetailsOpen(!sideBody.classList.contains('show-details'));
        });
      }

      initDetailsToggle();

      function setStatusPill(card){
        const min = Number(card.getAttribute('data-lastseen-min'));
        const s = computeOnlineStateFromMinutes(min);
        kvStatus.className = 'status-pill ' + (s.cls || '');
        kvStatus.textContent = s.label;
        kvSeen.textContent = (Number.isNaN(min) ? '-' : (min + ' min geleden'));
      }

      function renderPhones(card){
        const raw = (card.getAttribute('data-phones') || '').trim();
        if(!raw){
          sidePhones.innerHTML = '<li class="muted">Geen gegevens</li>';
          return;
        }
        const items = raw.split(',').map(x=>x.trim()).filter(Boolean).map(pair=>{
          const parts = pair.split('|');
          return { phone:(parts[0]||'').trim(), label:(parts[1]||'').trim() };
        });
        if(!items.length){
          sidePhones.innerHTML = '<li class="muted">Geen gegevens</li>';
          return;
        }
        sidePhones.innerHTML = '';
        items.forEach(it=>{
          const li = document.createElement('li');
          li.textContent = it.label ? (it.phone + ' (' + it.label + ')') : it.phone;
          sidePhones.appendChild(li);
        });
      }

      function selectCard(card){
        document.querySelectorAll('.gb-card.is-selected').forEach(x=>x.classList.remove('is-selected'));
        card.classList.add('is-selected');
      }

      const sharesStore = {};
      const sharesBody = document.querySelector('#sharesTable tbody');
      const sharePhone   = document.getElementById('sharePhone');
      const shareExpires = document.getElementById('shareExpires');
      const shareComment = document.getElementById('shareComment');
      const shareAuth    = document.getElementById('shareAuth');

      // =========================================================
      // 8) Shares UI
      // =========================================================
      
      // NIEUW: Haal shares op van de server
      async function fetchShares(boxId) {
        try {
          // Haal de echte data van de API
          const res = await fetch(apiUrl(`/api/boxes/${encodeURIComponent(boxId)}/shares`));
          if (!res.ok) return; // Geen ramp als het mislukt
          
          const data = await res.json();
          // Als de server een array teruggeeft, slaan we die op
          if (Array.isArray(data)) {
              // We mappen de server-data naar het formaat van jouw tabel
              sharesStore[boxId] = data.map(s => ({
                  ts: s.createdAt ? new Date(s.createdAt).toLocaleString() : '-',
                  phone: s.phone,
                  comment: s.comment,
                  expires: s.expiresAt,
                  auth: s.type === 'authorized',
                  // Bewaar ID voor delete acties
                  id: s.id 
              }));
              renderShares(boxId);
              updateSharesCountUiFromLocal(boxId);
          }
        } catch (e) {
          console.error("Kon shares niet ophalen", e);
        }
      }

      function renderShares(boxId){
        const rows = (sharesStore[boxId]||[]);
        sharesBody.innerHTML = '';
        if(!rows.length){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td colspan="5" class="muted" style="border-radius:12px;">Geen shares</td>`;
          sharesBody.appendChild(tr);
          return;
        }
        rows.forEach((r,i)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.ts}</td>
            <td>${r.phone}</td>
            <td>${(r.comment||'').replace(/</g,'&lt;')}</td>
            <td>${r.auth ? '<span class="badge">Gemachtigd</span>' : (r.expires ? '<span class="badge">Tijdelijk</span>' : '<span class="badge">Actief</span>')}</td>
            <td class="right"><button class="btn-small btn-ghost" data-del="${i}" type="button">Delete</button></td>
          `;
          sharesBody.appendChild(tr);
        });
      }

      function updateSharesCountUiFromLocal(boxId){
        const rows = (sharesStore[boxId]||[]);
        // Update de teller in het zijpaneel
        const badge = document.getElementById('kvSharesCount');
        if(badge) badge.textContent = 'shares ' + rows.length;

        updateAccessSummary(boxId);
      }

      function updateAccessSummary(boxId){
        if(!kvAccessSummary) return;
        if(!boxId) { kvAccessSummary.textContent = '-'; return; }
        if(!(boxId in sharesStore)) { kvAccessSummary.textContent = '-'; return; }
        const rows = (sharesStore[boxId] || []);

        if(!rows.length){
          kvAccessSummary.textContent = 'Geen shares';
          return;
        }

        const now = Date.now();
        let active = 0;
        let soonest = null;

        rows.forEach(r=>{
          if(r && r.auth === true){
            active += 1;
            return;
          }
          const exp = r ? r.expires : null;
          if(exp){
            const ms = parseAnyTime(exp);
            if(ms && ms < now) return; // verlopen
            active += 1;
            if(ms && (soonest === null || ms < soonest)) soonest = ms;
            return;
          }
          active += 1;
        });

        if(active <= 0){
          kvAccessSummary.textContent = 'Geen actieve shares';
          return;
        }

        const pad = n => String(n).padStart(2,'0');
        const fmtMini = (ms)=>{
          const d = new Date(ms);
          return pad(d.getDate()) + '/' + pad(d.getMonth()+1) + ' ' + pad(d.getHours()) + ':' + pad(d.getMinutes());
        };

        let s = 'Actief: ' + active;
        if(soonest !== null){
          s += ' (volgende vervalt: ' + fmtMini(soonest) + ')';
        }
        kvAccessSummary.textContent = s;
      }


      sharesBody.addEventListener('click', async (e) => { // Let op: 'async' toegevoegd
        const del = e.target.closest('button[data-del]');
        if (!del || !currentCard) return;
        
        const boxId = currentCard.getAttribute('data-id');
        const idx = Number(del.getAttribute('data-del'));
        
        // Haal het juiste share-object op uit het geheugen om het ID te vinden
        const shareObj = sharesStore[boxId] && sharesStore[boxId][idx];

        // Veiligheidscheck
        if (!shareObj || !shareObj.id) {
            // Als er geen ID is (bv net lokaal aangemaakt), verwijder dan alleen lokaal
            if(sharesStore[boxId]) sharesStore[boxId].splice(idx, 1);
            renderShares(boxId);
            updateSharesCountUiFromLocal(boxId);
            return;
        }

        // 1. Roep de server aan om te verwijderen (Soft delete)
        try {
            const res = await fetch(apiUrl(`/api/boxes/${encodeURIComponent(boxId)}/shares/${shareObj.id}`), {
                method: 'DELETE'
            });
            
            if (!res.ok) {
                console.error("Server fout bij delete", res.status);
                alert("Kon share niet verwijderen op de server.");
                return; 
            }
        } catch (err) {
            console.error("Netwerk fout", err);
            alert("Kon server niet bereiken.");
            return;
        }

        // 2. Als de server OK zegt, verwijder dan ook uit het scherm
        sharesStore[boxId].splice(idx, 1);
        renderShares(boxId);
        updateSharesCountUiFromLocal(boxId);
      });

      function updateSharesCountUiFromCard(card){
        const raw = (card.getAttribute('data-shares-count') || '').trim();
        if(!raw){
          kvSharesCount.textContent = 'shares -';
          return;
        }
        const n = Number(raw);
        if(Number.isNaN(n)){
          kvSharesCount.textContent = 'shares -';
          return;
        }
        kvSharesCount.textContent = 'shares ' + n;
      }

      // =========================================================
      // AANGEPASTE SHARE KNOP (Stuurt nu naar Server/API)
      // =========================================================
      document.getElementById('shareAdd').addEventListener('click', async () => {
        if (!currentCard) return alert('Selecteer eerst een Gridbox links.');

        const boxId = currentCard.getAttribute('data-id');
        const boxNumber = Number(currentCard.getAttribute('data-box') || '');

        const phoneInput = document.getElementById('sharePhone');
        const commentInput = document.getElementById('shareComment');
        const expiresInput = document.getElementById('shareExpires');
        const authInput = document.getElementById('shareAuth');

        const phoneRaw = phoneInput.value.trim();
        const comment = commentInput.value.trim();
        const expires = expiresInput.value.trim();
        const auth = !!authInput.checked;

        if (!phoneRaw) return alert('Vul een telefoonnummer in.');
        if (!boxId || boxId === '-') return alert('Box id ontbreekt.');
        if (!Number.isFinite(boxNumber)) return alert('Box nummer ontbreekt.');

        function normalizePhoneForShare(number){
          if (!number) return '';
          let s = String(number).trim().replace(/\s+/g, '');
          if (s.startsWith('00')) s = '+' + s.slice(2);
          if (s.startsWith('0')) s = '+32' + s.slice(1);
          return s;
        }

        const phone = normalizePhoneForShare(phoneRaw);

        const payload = {
          phone,
          boxNumber,
          boxId,
          expiresAt: expires || null,
          comment,
          auth
        };

        try {
          const res = await fetch(apiUrl('/api/shares'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!res.ok) {
            const txt = await res.text().catch(()=> '');
            throw new Error(txt || ('Opslaan mislukt: ' + res.status));
          }

          const json = await res.json().catch(()=> ({}));

          // UI bijwerken
          sharesStore[boxId] = sharesStore[boxId] || [];

          const now = new Date();
          const pad = n => String(n).padStart(2, '0');
          const tsDisplay = `${pad(now.getDate())}/${pad(now.getMonth() + 1)} ${pad(now.getHours())}:${pad(now.getMinutes())}`;

          sharesStore[boxId].unshift({
            ts: tsDisplay,
            phone,
            comment,
            expires,
            auth,
            id: json.shareId || json.id
          });

          renderShares(boxId);
          updateSharesCountUiFromLocal(boxId);

          // Velden leegmaken
          phoneInput.value = '';
          commentInput.value = '';
          expiresInput.value = '';
          authInput.checked = false;

          if (json.smsSent === true) {
            alert('Share opgeslagen en sms verstuurd.');
          } else if (json.smsSent === false) {
            alert('Share opgeslagen, maar sms niet verstuurd: ' + (json.smsError || 'onbekende reden'));
          } else {
            alert('Share opgeslagen.');
          }

        } catch (err) {
          console.error(err);
          alert('Fout bij opslaan share: ' + (err.message || err));
        }
      });

      function scrollSideToBlock(blockId){
        const el = document.getElementById(blockId);
        if(!el) return;
        const top = side.scrollTop + el.getBoundingClientRect().top - side.getBoundingClientRect().top - 10;
        side.scrollTo({ top, behavior:'smooth' });
      }

      function fmtLifecycleLine(at, by){
        const a = (at && at !== '-') ? at : '';
        const b = (by && by !== '-') ? by : '';
        if (!a && !b) return '-';
        if (a && b) return a + ' (' + b + ')';
        return a || b;
      }

      // =========================================================
      // 7) Side panel details
      // =========================================================

      function normalizeDesiredValue(v){
        const s = String(v ?? '').trim().toLowerCase();
        if(!s) return '';
        if(s === 'open' || s === 'opened' || s === 'opening') return 'open';
        if(s === 'close' || s === 'closed' || s === 'closing') return 'close';
        return s;
      }

      function desiredLabel(v){
        if(v === 'open') return 'Open';
        if(v === 'close') return 'Dicht';
        return fmtMaybe(v);
      }

      function fmtLocalDateTime(v){
        const ms = parseAnyTime(v);
        if(!ms) return fmtMaybe(v);
        const d = new Date(ms);
        const pad = n => String(n).padStart(2,'0');
        return pad(d.getDate()) + '/' + pad(d.getMonth()+1) + '/' + d.getFullYear() + ' ' + pad(d.getHours()) + ':' + pad(d.getMinutes());
      }

      function fmtSince(v){
        const ms = parseAnyTime(v);
        if(!ms) return '';
        const min = Math.floor((Date.now() - ms) / 60000);
        if(min < 0) return '';
        return '(sinds ' + fmtTimeAgo(min) + ')';
      }

      function setAlertLine(text, level){
        if(!kvAlert) return;
        const t = String(text || '').trim();
        if(!t){
          kvAlert.style.display = 'none';
          kvAlert.textContent = '';
          kvAlert.className = 'alert';
          return;
        }
        kvAlert.style.display = 'block';
        kvAlert.textContent = t;
        kvAlert.className = 'alert ' + (level || 'warn');
      }

      function computeNowInfo(card){
        const motion = normalizeShutterStateDetailed(card.getAttribute('data-motion-state') || '');
        const door = normalizeShutterStateDetailed(card.getAttribute('data-door-state') || '');

        if(motion === 'opening') return { label:'Bezig (openen)', base:'opening' };
        if(motion === 'closing') return { label:'Bezig (sluiten)', base:'closing' };

        if(door === 'open') return { label:'Open', base:'open' };
        if(door === 'closed') return { label:'Dicht', base:'closed' };

        if(card.classList.contains('is-open')) return { label:'Open', base:'open' };
        if(card.classList.contains('is-closed')) return { label:'Dicht', base:'closed' };

        // fallback
        return { label:'Onbekend', base:'' };
      }

      function updateSummaryFromCard(card){
        if(!card) return;

        const nowInfo = computeNowInfo(card);
        if(kvNowState) kvNowState.textContent = nowInfo.label || '-';

        const openedAt = card.getAttribute('data-opened-at') || '';
        const closedAt = card.getAttribute('data-closed-at') || '';

        if(kvNowSince){
          let since = '';
          if(nowInfo.base === 'open') since = fmtSince(openedAt);
          if(nowInfo.base === 'closed') since = fmtSince(closedAt);
          kvNowSince.textContent = since ? (' ' + since) : '';
        }

        const door = normalizeShutterStateDetailed(card.getAttribute('data-door-state') || '');
        if(kvNowConfirm){
          kvNowConfirm.textContent = 'Timing (geen sensor)';
        }

        const desired = normalizeDesiredValue(card.getAttribute('data-desired') || '');
        if(kvDesired) kvDesired.textContent = desired ? desiredLabel(desired) : '-';

        const desiredBy = (card.getAttribute('data-desired-by') || '').trim();
        const desiredAt = (card.getAttribute('data-desired-at') || '').trim();
        if(kvDesiredMeta){
          let meta = '';
          if(desiredBy) meta += 'door ' + desiredBy;
          if(desiredAt) meta += (meta ? ' om ' : 'om ') + fmtLocalDateTime(desiredAt);
          kvDesiredMeta.textContent = meta ? (' (' + meta + ')') : '';
        }

        // Laatste actie
        const openedBy = (card.getAttribute('data-opened-by') || '').trim();
        const closedBy = (card.getAttribute('data-closed-by') || '').trim();
        const source = (card.getAttribute('data-source') || '').trim();

        const tOpen = parseAnyTime(openedAt) || 0;
        const tClose = parseAnyTime(closedAt) || 0;

        let kind = '-';
        let at = '';
        let by = '';
        if(tOpen == 0 && tClose == 0){
          kind = '-';
        } else if(tOpen >= tClose){
          kind = 'Geopend';
          at = openedAt;
          by = openedBy;
        } else {
          kind = 'Gesloten';
          at = closedAt;
          by = closedBy;
        }

        if(kvLastAction) kvLastAction.textContent = kind;
        if(kvLastActionMeta){
          let meta = '';
          if(at) meta += fmtLocalDateTime(at);
          if(by) meta += (meta ? ' door ' : 'door ') + by;
          if(source) meta += (meta ? ' via ' : 'via ') + source;
          kvLastActionMeta.textContent = meta ? (' (' + meta + ')') : '';
        }

        // Verbinding
        const min = Number(card.getAttribute('data-lastseen-min'));
        const st = computeOnlineStateFromMinutes(min);
        if(kvConn) kvConn.textContent = st.label || '-';
        if(kvConnMeta){
          const ago = fmtTimeAgo(min);
          kvConnMeta.textContent = ago ? (' (' + ago + ')') : '';
        }

        const boxId = card.getAttribute('data-id');
        // Toegang: als shares nog niet geladen zijn, toon minstens de teller van de backend
        if(boxId && !(boxId in sharesStore)) {
          const raw = (card.getAttribute('data-shares-count') || '').trim();
          if(kvAccessSummary) kvAccessSummary.textContent = raw ? ('Shares: ' + raw) : '-';
        } else {
          updateAccessSummary(boxId);
        }

        // Alert lijn
        const motion = normalizeShutterStateDetailed(card.getAttribute('data-motion-state') || '');
        if(st.cls === 'bad'){
          setAlertLine('Box is offline', 'bad');
        } else if(motion === 'opening'){
          setAlertLine('Box is bezig met openen', 'ok');
        } else if(motion === 'closing'){
          setAlertLine('Box is bezig met sluiten', 'ok');
        } else if(desired === 'open' && nowInfo.base === 'closed'){
          setAlertLine('Gewenst is open maar box is dicht', 'warn');
        } else if(desired === 'close' && nowInfo.base === 'open'){
          setAlertLine('Gewenst is dicht maar box is open', 'warn');
        } else {
          setAlertLine('', '');
        }
      }

      function updateSideFromCard(card, contextLabel, opts){
        opts = opts || {};
        currentCard = card;
        selectCard(card);

        const sec = card.closest('.gb-section');
        const customer = (sec ? sec.getAttribute('data-customer') : '-') || '-';

        const siteName = card.getAttribute('data-site') || '-';
        const boxNr = card.getAttribute('data-box') || '-';
        const address = card.getAttribute('data-address') || '-';

        sideTitle.textContent = `${siteName} #${boxNr}`;
        sideSub.textContent = contextLabel || 'Beheer en overzicht';

        kvCustomer.textContent = customer;
        kvSite.textContent = siteName || '-';
        kvBox.textContent = '# ' + (boxNr || '-');
        kvAddress.textContent = address || '-';

        kvActive.textContent = card.getAttribute('data-active') || '-';
        kvAccess24h.textContent = card.getAttribute('data-access24h') || '-';
        kvType.textContent = card.getAttribute('data-type') || '-';
        kvDescription.textContent = card.getAttribute('data-desc') || '-';
        kvLifecycleState.textContent = card.getAttribute('data-lifecycle-state') || '-';

        const openedAt = card.getAttribute('data-opened-at') || '-';
        const openedBy = card.getAttribute('data-opened-by') || '-';
        const closedAt = card.getAttribute('data-closed-at') || '-';
        const closedBy = card.getAttribute('data-closed-by') || '-';

        kvOpened.textContent = fmtLifecycleLine(openedAt, openedBy);
        kvClosed.textContent = fmtLifecycleLine(closedAt, closedBy);
        kvSource.textContent = card.getAttribute('data-source') || '-'; 
        kvGeo.textContent = card.getAttribute('data-geo') || '-';

        kvAgent.textContent = (card.getAttribute('data-agent') ? ('v ' + card.getAttribute('data-agent')) : '-');
        kvProfile.textContent = (card.getAttribute('data-profile') || '-');

        setStatusPill(card);
        renderPhones(card);

        const boxId = card.getAttribute('data-id');
        
        if(!opts.silent){
        // Eerst lokale lege tabel tonen
        renderShares(boxId);
        // Dan ophalen van server
        fetchShares(boxId);
      }

        updateSharesCountUiFromCard(card);
        updateSharesCountUiFromLocal(boxId);
        updateSummaryFromCard(card);
        if(!opts.silent) openSide();
      }

      document.getElementById('btnGoShares').addEventListener('click', ()=>{
        if(!currentCard) return alert('Selecteer eerst een Gridbox links.');
        updateSideFromCard(currentCard, 'Toegang beheren');

        side.classList.add('is-wide');
        app.classList.remove('is-collapsed');
        app.classList.add('is-expanded');

        setDetailsOpen(true);
        setTimeout(()=>scrollSideToBlock('blockShares'), 0);
      });

      // =========================================================
      // 9) Card acties
      // =========================================================

      document.addEventListener('click', async (e)=>{
        // ---------------------------------------------------------
        // KNOPPEN LOGICA
        // ---------------------------------------------------------
        const btn = e.target.closest('button[data-action]');
        const card = e.target.closest('.gb-card');
        
        if(!card) return; // Geen kaart? Stop.

        // Als er op een knop is gedrukt
        if(btn){
          const action = btn.getAttribute('data-action');
          const boxId = card.getAttribute('data-id');

          // --- ACTIE: TOGGLE (OPEN/CLOSE) ---
          if(action === 'toggle'){
            e.preventDefault(); e.stopPropagation();

            const label = String(btn.textContent || '').trim().toUpperCase();
            let next = '';
            if(label === 'OPEN') next = 'open';
            else if(label === 'CLOSE') next = 'close';
            else next = card.classList.contains('is-open') ? 'close' : 'open';

            if (!boxId || boxId === '-'){
              alert('Box id ontbreekt.');
              return;
            }

            // Toon alleen "verzonden", geen fake open/close
            setPending(boxId, next);

            const statusText = card.querySelector('.js-status-text');
            if(statusText) statusText.textContent = (next === 'open') ? 'Open gevraagd (wachten op box)' : 'Dicht gevraagd (wachten op box)';

            const prevLabel = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'VERZENDEN...';

            try{
              // Probeer eerst dedicated endpoint (als het bestaat)
              let sent = false;
              try{
                await sendCommand(boxId, next); // /open of /close
                sent = true;
              } catch(_){
                // fallback
              }

              if(!sent){
                await setDesired(boxId, next);
              }

              card.setAttribute('data-desired', next);

              // Fast follow-up voor snelle UI (tot 45s)
              startFastWatch(boxId);

            } catch(err){
              clearPending(boxId);
              await refreshOneBoxNow(boxId);
              alert('Actie mislukt: ' + (err.message || err));
            } finally {
              // na korte tijd opnieuw klikbaar, echte label volgt via refresh
              setTimeout(()=>{
                btn.disabled = false;
                btn.textContent = prevLabel;
              }, 1200);
            }

            return;
          }


          // --- ACTIE: SHARES ---
          if(action === 'shares'){
            e.preventDefault(); e.stopPropagation();
            updateSideFromCard(card, 'Toegang beheren');
            side.classList.add('is-wide');
            app.classList.remove('is-collapsed');
            app.classList.add('is-expanded');
            setDetailsOpen(true);
            setTimeout(()=>scrollSideToBlock('blockShares'), 0);
            return;
          }

          // --- ACTIE: EVENTS ---
          if(action === 'events'){
            e.preventDefault(); e.stopPropagation();
            updateSideFromCard(card, 'Beheer en overzicht');
            setDetailsOpen(true);
            if (boxId && boxId !== '-') openLink(`/api/boxes/${encodeURIComponent(boxId)}/events`);
            setTimeout(()=>scrollSideToBlock('blockEvents'), 0);
            return;
          }

          // --- ACTIE: PICTURES ---
          if(action === 'pictures'){
            e.preventDefault(); e.stopPropagation();
            updateSideFromCard(card, 'Beheer en overzicht');
            if (boxId && boxId !== '-') openLink(`/api/boxes/${encodeURIComponent(boxId)}/pictures`);
            return;
          }
        }

        // Als er op de kaart geklikt is (maar niet op een specifieke knop), open zijpaneel
        updateSideFromCard(card, 'Beheer en overzicht');
      });

     document.getElementById('btnEvents').addEventListener('click', ()=>{
        if(!currentCard) return alert('Selecteer eerst een Gridbox links.');
        const boxId = currentCard.getAttribute('data-id');
        if (boxId && boxId !== '-') openLink(`/api/boxes/${encodeURIComponent(boxId)}/events`);
      });

      document.getElementById('btnPictures').addEventListener('click', ()=>{
        if(!currentCard) return alert('Selecteer eerst een Gridbox links.');
        const boxId = currentCard.getAttribute('data-id');
        if (boxId && boxId !== '-') openLink(`/api/boxes/${encodeURIComponent(boxId)}/pictures`);
      });

      // =========================================================
      // 10) Init
      // =========================================================

      (async function init(){
        try{
          const boxes = await loadBoxes();
          renderSectionsFromBoxes(boxes);
        } catch(err){
          console.error(err);
          sectionsWrap.innerHTML = `<div class="muted">Kon gridboxen niet laden</div>`;
          rebuildFilters();
        }
      })();

      // =========================================================
      // 11) AUTO REFRESH LOOP (Elke 15s)
      // =========================================================
      setInterval(async function() {
        // 1. Onthoud welke kaart geselecteerd is (zodat het menu niet dichtklapt)
        const selected = document.querySelector('.gb-card.is-selected');
        const selectedId = selected ? selected.getAttribute('data-id') : null;

        try {
          // 2. Haal de nieuwe data op
          const boxes = await loadBoxes();
          renderSectionsFromBoxes(boxes);

          // 3. Zet de selectie terug
          if(selectedId){
             const newCard = document.querySelector(`.gb-card[data-id="${selectedId}"]`);
             if(newCard){
                 newCard.classList.add('is-selected');
                 
                 // Als het zijpaneel open staat, update dan ook de tekst daar
                 const side = document.getElementById('side');
                 if(side && side.classList.contains('is-open')){
                     if(typeof updateSideFromCard === 'function') {
                         // We behouden de titel (context) als die er is
                         const currentTitle = document.getElementById('sideSub').textContent;
                         updateSideFromCard(newCard, currentTitle, { silent:true }); 
                     }
                 }
             }
          }
        } catch(e) {
          console.error("Auto-refresh mislukt (geen ramp, volgende keer beter)", e);
        }
      }, 15000); // 15000 ms = 15 seconden

    })();
  </script>
</body>
</html>
